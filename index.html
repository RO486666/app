<!DOCTYPE html>
<html lang="de">
<head>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#00aa44" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trade App Layout</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    .header {
      background: #1c1c1c;
      padding: 10px;
      text-align: center;
      font-size: 18px;
    }
    .session-bar {
      height: 10px;
      background: linear-gradient(to right, #00aaff, #ffaa00, #ff3300);
      margin-top: 5px;
    }
	
    .main {
      padding: 20px;
      padding-bottom: 120px; /* Platz fÃ¼r Positionsleiste */
      text-align: center;
    }
    .big-btn {
      padding: 20px 30px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 15px;
      border: none;
      background-color: #00aa44;
      color: white;
      margin: 20px auto;
      width: 80%;
      max-width: 300px;
    }
    .tab-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .tab-buttons button {
      background: #333;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      margin: 5px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .tab-buttons .active {
      background: #0077cc;
    }
    .stats-box {
      background: #222;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    #resetBtn {
      background: #cc3333;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      font-weight: bold;
      margin: 20px auto 30px auto;
      cursor: pointer;
      display: block;
      user-select: none;
      position: relative; /* kein fixed */
      z-index: auto;
    }
    .position-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #1c1c1c;
      padding: 10px;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      box-sizing: border-box;
      z-index: 10000; /* Ã¼ber anderen Elementen */
	  touch-action: pan-y; /* Erlaubt vertikales Scrollen, verhindert horizontale Interferenzen */
    }
    
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      display: none;
      z-index: 1000;
      width: 90%;
      max-width: 300px;
      color: white;
    }
    label {
      cursor: pointer;
      user-select: none;
      margin-right: 15px;
      display: inline-block;
    }
    #pairMultiSelect {
      max-height: 150px;
      overflow-y: auto;
      background: #222;
      padding: 5px;
      border-radius: 6px;
      color: white;
      margin-bottom: 10px;
      text-align: left;
    }
    select, input {
      padding: 8px;
      margin-top: 10px;
      width: 100%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    .popup button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
    }
    .ticker {
      width: 100%;
      background: #222;
      color: #00ff99;
      padding: 10px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      user-select: none;
    }
    .session-info {
      margin-top: 5px;
      font-size: 14px;
      color: #aaf0aa;
      text-align: center;
      font-style: italic;
      user-select: none;
    }
	
.session-details-box {
  display: none;
  background: #1a1a1a;
  padding: 15px;
  margin: 10px 20px;
  border-radius: 10px;
  font-size: 14px;
  color: #eee;
  text-align: left;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
}


  .session-details-box {
    font-size: 13px;
    margin: 10px;
    padding: 12px;
    line-height: 1.4;
  }

  .session-header, #sessionText {
    font-size: 16px;
    padding: 12px;
  }
  
  #sessionText {
  user-select: none;
  cursor: pointer;
}
    .progress-container {
      position: relative;
      background: #111;
      height: 24px;
      width: 100%;
      border-top: 1px solid #333;
      border-bottom: 1px solid #333;
      overflow: hidden;
      border-radius: 6px;
      margin-top: 5px;
    }
    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%; /* wird per JS gesetzt */
      background: linear-gradient(to right, #00aaff, #ffaa00, #ff3300);
      transition: width 1s linear;
      background-size: 100% 100%;
      background-repeat: no-repeat;
      z-index: 2;
    }
	
	.session-details-box ul {
  padding-left: 20px;
  margin-top: 8px;
  margin-bottom: 8px;
  list-style-type: disc;
}

.session-details-box li {
  margin-bottom: 4px;
}

.tool-button {
  background-color: #333;
  color: white;
  border: none;
  padding: 10px 20px;
  margin: 5px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}
.tool-button:hover {
  background-color: #444;
}
.tool-box {
  background: #222;
  padding: 20px;
  border-radius: 10px;
  color: white;
  max-width: 400px;
  margin: auto;
  box-shadow: 0 0 10px rgba(255,255,255,0.1);
}

.tool-box input,
.tool-box button {
  width: 100%;
  margin-bottom: 10px;
  padding: 8px;
  border: none;
  border-radius: 5px;
  font-size: 14px;
}

.tool-box button {
  background: #007bff;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

.crypto-animate {
  font-weight: bold;
  font-size: 18px;
  color: #00ffcc;
  text-shadow: 0 0 5px #00ffcc, 0 0 10px #00ffcc, 0 0 20px #00ffcc;
  animation: glowPulse 2s infinite alternate;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.crypto-animate .coin {
  display: inline-block;
  animation: spinCoin 1.5s linear infinite;
  font-size: 22px;
}

@keyframes spinCoin {
  0%   { transform: rotateY(0deg); }
  100% { transform: rotateY(360deg); }
}

@keyframes glowPulse {
  0% {
    text-shadow: 0 0 5px #00ffcc, 0 0 10px #00ffcc;
  }
  100% {
    text-shadow: 0 0 15px #00ffcc, 0 0 30px #00ffcc;
  }
}

.star-rating {
  unicode-bidi: bidi-override;
  direction: rtl;
  display: inline-flex;
}
.star-rating span {
  font-size: 24px;
  cursor: pointer;
  color: #777;
}
.star-rating span.selected {
  color: gold;
}


.journal-screenshot {
  max-width: 160px;
  max-height: 120px;
  width: auto;
  height: auto;
  object-fit: contain;
  border-radius: 6px;
  margin-top: 5px;
  display: block;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.trade-box {
  background: #222;
  border-radius: 8px;
  margin-top: 8px;
  padding: 0;
  overflow: hidden;
}

.trade-box summary {
  padding: 10px;
  cursor: pointer;
  font-weight: bold;
  background: #333;
  color: #fff;
  list-style: none;
}

.trade-box summary::-webkit-details-marker {
  display: none;
}

.trade-details {
  padding: 10px;
  background: #1a1a1a;
  color: #eee;
}



	
  </style>
</head>
<body>







<div class="ticker" id="sessionText">Session-Zeit: 00:00</div>
<div class="session-info" id="sessionInfo">Tipps und Infos zur Session erscheinen hier...</div>
<div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
</div>
<div id="daySummary" class="ticker" style="background:#333; color:#ffcc00; font-size:16px; cursor:pointer;">
  ğŸ—“ï¸ Lade Tagesinfo...
</div>
<div id="dayDetails" style="
  display: none;
  background: #1c1c1c;
  color: white;
  margin: 10px 15px;
  padding: 10px;
  border-radius: 10px;
  font-size: 14px;
  line-height: 1.6;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  text-align: left;
  user-select: none;
">
</div>

<div id="sessionProgressDisplay"
     style="text-align:center;
            font-size: 16px;
            font-weight: bold;
            margin-top: 8px;
            color: #00ff99;
            background: #111;
            padding: 6px;
            border-radius: 8px;">
</div>

<div class="session-details-box" id="sessionDetailsBox"></div>
<div class="alert-below-header" id="alertBox"></div>

<div class="tab-buttons" style="margin-top: 20px;">
  <button class="btn" id="btn-calc-pos" onclick="switchCalcTab('pos')">ğŸ“ Position Size</button>
  <button class="btn" id="btn-calc-lot" onclick="switchCalcTab('lot')">ğŸ§® Lot-Rechner</button>
  <button class="btn" id="btn-calc-breakeven" onclick="switchCalcTab('breakeven')">ğŸ§  Break-even</button>
</div>
</div>



<div id="calc-pos" class="calc-box" style="margin-top: 15px; display:none;">

  <div class="stats-box">
    <label for="accountSize">ğŸ“¦ KontogrÃ¶ÃŸe (â‚¬):</label>
    <input type="number" id="accountSize" placeholder="z.â€¯B. 1000" />

    <label for="riskPercent">âš ï¸ Risiko in %:</label>
    <input type="number" id="riskPercent" placeholder="z.â€¯B. 1" step="0.1" />

    <label for="stopLossPips">ğŸ›‘ Stop-Loss (in Pips):</label>
    <input type="number" id="stopLossPips" placeholder="z.â€¯B. 20" />

<label for="symbolSelector">ğŸ’± Trading-Paar:</label>
<select id="symbolSelector">
  <optgroup label="ğŸŒ Forex Standard">
    <option value="AUD/USD">AUD/USD</option>
    <option value="EUR/USD">EUR/USD</option>
    <option value="GBP/USD">GBP/USD</option>
    <option value="NZD/USD">NZD/USD</option>
    <option value="USD/CHF">USD/CHF</option>
    <option value="USD/CAD">USD/CAD</option>
  </optgroup>

  <optgroup label="ğŸ’´ Forex Yen-Paare">
    <option value="USD/JPY">USD/JPY</option>
    <option value="EUR/JPY">EUR/JPY</option>
    <option value="GBP/JPY">GBP/JPY</option>
    <option value="CHF/JPY">CHF/JPY</option>
    <option value="AUD/JPY">AUD/JPY</option>
    <option value="NZD/JPY">NZD/JPY</option>
    <option value="CAD/JPY">CAD/JPY</option>
  </optgroup>

  <optgroup label="ğŸ” Cross-Paare">
    <option value="EUR/GBP">EUR/GBP</option>
    <option value="EUR/AUD">EUR/AUD</option>
    <option value="EUR/CAD">EUR/CAD</option>
    <option value="GBP/AUD">GBP/AUD</option>
    <option value="GBP/CAD">GBP/CAD</option>
    <option value="AUD/CAD">AUD/CAD</option>
  </optgroup>

  <optgroup label="ğŸ¥‡ Metalle">
    <option value="XAU/USD">XAU/USD</option>
    <option value="XAG/USD">XAG/USD</option>
  </optgroup>

  <optgroup label="ğŸª™ Krypto">
    <option value="BTC/USD">BTC/USD</option>
    <option value="ETH/USD">ETH/USD</option>
  </optgroup>

  <optgroup label="ğŸ“Š Indizes">
    <option value="US30">US30</option>
    <option value="NAS100">NAS100</option>
    <option value="SPX500">SPX500</option>
    <option value="GER40">GER40</option>
    <option value="UK100">UK100</option>
  </optgroup>
  
</select>

<label for="leverage">âš™ï¸ Hebel:</label>
<input type="number" id="leverage" value="500" min="1" placeholder="z.â€¯B. 500" />




    <button onclick="calculatePositionSize()">ğŸ“ Berechnen</button>
    <p id="positionSizeResult" style="font-weight: bold; font-size: 18px; margin-top: 10px;"></p>
  </div>

  <div style="text-align:right; margin-bottom: 5px;">
    <span onclick="toggleInfoBox()" 
          style="cursor:pointer; background:#444; border-radius:50%; padding:3px 8px; font-weight:bold; color:#0ff;"
          title="ErklÃ¤rung anzeigen">i</span>
  </div>
  <div id="posInfoBox" style="display:none; background:#222; padding:12px; border-radius:8px; margin-top:10px; color:#ccc; font-size:14px; text-align:left;">
    <strong>â„¹ï¸ Was macht dieser Rechner?</strong><br><br>
    Der PositionsgrÃ¶ÃŸen-Rechner hilft dir zu ermitteln, wie viele Lots du in einem Trade einsetzen darfst, ohne mehr als einen bestimmten Prozentsatz deines Kontos zu riskieren. Die Berechnung basiert auf vier Angaben:
    <ul style="margin-top:10px; margin-bottom:10px;">
      <li><strong>ğŸ“¦ KontogrÃ¶ÃŸe:</strong> Dein aktuelles Guthaben in Euro.</li>
      <li><strong>âš ï¸ Risiko in %:</strong> Wie viel Prozent deines Kontos du maximal pro Trade verlieren willst (z.â€¯B. 1%).</li>
      <li><strong>ğŸ›‘ Stop-Loss (Pips):</strong> Die Distanz zwischen Einstieg und Stop-Loss in Pips.</li>
      <li><strong>ğŸ’¡ Pip-Wert pro Lot:</strong> Wie viel ein Pip pro Standard-Lot wert ist (z.â€¯B. 10â€¯â‚¬ bei EUR/USD).</li>
    </ul>
    <strong>ğŸ“ Formel:</strong><br>
    <code style="color:#0ff;">PositionsgrÃ¶ÃŸe = (KontogrÃ¶ÃŸe Ã— Risiko%) / (Stop-Loss Ã— Pip-Wert)</code><br><br>
    <strong>ğŸ” Beispiel:</strong><br>
    KontogrÃ¶ÃŸe: 1000 â‚¬<br>
    Risiko: 2%<br>
    Stop-Loss: 20 Pips<br>
    Pip-Wert: 10 â‚¬/Lot<br><br>
    <strong>â†’</strong> Du riskierst 20 â‚¬ (1000â€¯Ã—â€¯0,02).<br>
    <strong>â†’</strong> Bei 20 Pips wÃ¤ren das 1â€¯â‚¬/Pip erlaubt (20â€¯â‚¬ / 20â€¯Pips).<br>
    <strong>â†’</strong> Der Pip-Wert ist 10â€¯â‚¬/Lot â‡’ <strong>Erlaubte LotgrÃ¶ÃŸe: 0.10</strong><br><br>
    <em style="color:#aaa;">Hinweis: Bei Indizes oder Gold kann der Pip-Wert unterschiedlich sein!</em>
  </div>
</div>


  <div style="text-align:right; margin-bottom: 5px;">
    <span onclick="toggleRiskInfo()" 
          style="cursor:pointer; background:#444; border-radius:50%; padding:3px 8px; font-weight:bold; color:#0ff;"
          title="ErklÃ¤rung anzeigen">i</span>
  </div>

  <div id="riskInfoBox" style="display:none; background:#222; padding:12px; border-radius:8px; margin-top:10px; color:#ccc; font-size:14px; text-align:left;">
    <strong>â„¹ï¸ Was macht dieser Rechner?</strong><br><br>
    Der Risiko-%-Rechner zeigt dir, wie viel Geld du bei einem Trade riskierst und wie viel Prozent deines Kontos das ausmacht. Er basiert auf:

    <ul style="margin-top:10px; margin-bottom:10px;">
      <li><strong>ğŸ“¦ KontogrÃ¶ÃŸe:</strong> Dein Kontoguthaben in Euro</li>
      <li><strong>ğŸ§® LotgrÃ¶ÃŸe:</strong> Wie groÃŸ dein Trade ist (z.â€¯B. 0.1 = Mini-Lot)</li>
      <li><strong>ğŸ›‘ Stop-Loss (Pips):</strong> Wie weit der SL vom Einstieg entfernt ist</li>
      <li><strong>ğŸ’¡ Pip-Wert:</strong> Wie viel 1 Pip pro Lot kostet (z.â€¯B. 10â€¯â‚¬)</li>
    </ul>

    <strong>ğŸ“ Formel:</strong><br>
    <code style="color:#0ff;">Risiko (â‚¬) = LotgrÃ¶ÃŸe Ã— SL Ã— Pip-Wert<br>
    Risiko-% = Risiko / KontogrÃ¶ÃŸe Ã— 100</code><br><br>

    <strong>ğŸ” Beispiel:</strong><br>
    Konto: 1000â€¯â‚¬<br>
    Lot: 0.2<br>
    SL: 30 Pips<br>
    Pip-Wert: 10â€¯â‚¬<br>
    â†’ Risiko = 0.2 Ã— 30 Ã— 10 = 60â€¯â‚¬<br>
    â†’ Risiko-% = 60 / 1000 = <strong>6â€¯%</strong><br><br>

    <em style="color:#aaa;">Achte darauf, dass dein Risiko unter 2â€¯% bleibt, um langfristig zu Ã¼berleben.</em>
  </div>
</div>



<div id="calc-lot" class="calc-box" style="display:none; margin-top: 15px;">
  <div class="stats-box">
    <label for="lotFixedRisk">ğŸ’° Risiko in Euro:</label>
    <input type="number" id="lotFixedRisk" placeholder="z.â€¯B. 50" />

    <label for="lotSL">ğŸ›‘ Stop-Loss (in Pips):</label>
    <input type="number" id="lotSL" placeholder="z.â€¯B. 20" />

    <label for="lotPipValue">ğŸ’¡ Pip-Wert pro Lot (â‚¬):</label>
    <input type="number" id="lotPipValue" placeholder="z.â€¯B. 10" value="10" />

    <button onclick="calculateLotFromFixed()">ğŸ§® LotgrÃ¶ÃŸe berechnen</button>

    <p id="lotResult" style="font-weight: bold; font-size: 18px; margin-top: 10px;"></p>
  </div>

  <div style="text-align:right; margin-bottom: 5px;">
    <span onclick="toggleLotInfo()" 
          style="cursor:pointer; background:#444; border-radius:50%; padding:3px 8px; font-weight:bold; color:#0ff;"
          title="ErklÃ¤rung anzeigen">i</span>
  </div>

  <div id="lotInfoBox" style="display:none; background:#222; padding:12px; border-radius:8px; margin-top:10px; color:#ccc; font-size:14px; text-align:left;">
    <strong>â„¹ï¸ Was macht dieser Rechner?</strong><br><br>
    Du gibst an, wie viel Euro du maximal verlieren willst â€“ der Rechner sagt dir, welche LotgrÃ¶ÃŸe das erlaubt.<br><br>

    <strong>Beispiel:</strong><br>
    Risiko: 100â€¯â‚¬<br>
    SL: 25 Pips<br>
    Pip-Wert: 10â€¯â‚¬/Lot<br>
    â†’ <code style="color:#0ff;">Lots = 100 / (25 Ã— 10) = 0.40</code>
  </div>
</div>

<div id="calc-breakeven" class="calc-box" style="display:none; margin-top: 15px;">
  <div class="stats-box">
    <label for="entryPrice">ğŸ¯ Einstiegspreis:</label>
    <input type="number" id="entryPrice" placeholder="z.â€¯B. 1.12345" step="0.00001" />

    <label for="spreadPips">ğŸ“ Spread (Pips):</label>
    <input type="number" id="spreadPips" placeholder="z.â€¯B. 1.5" step="0.1" />

    <label for="fees">ğŸ’¸ GebÃ¼hren (â‚¬):</label>
    <input type="number" id="fees" placeholder="z.â€¯B. 2.00" step="0.01" />

    <label for="beLotSize">ğŸ§® LotgrÃ¶ÃŸe:</label>
    <input type="number" id="beLotSize" placeholder="z.â€¯B. 0.1" step="0.01" />

    <label for="bePipValue">ğŸ’¡ Pip-Wert pro Lot (â‚¬):</label>
    <input type="number" id="bePipValue" placeholder="z.â€¯B. 10" value="10" />

    <button onclick="calculateBreakeven()">ğŸ§  Break-even berechnen</button>

    <p id="breakevenResult" style="font-weight: bold; font-size: 18px; margin-top: 10px;"></p>
  </div>

  <div style="text-align:right; margin-bottom: 5px;">
    <span onclick="toggleBreakevenInfo()" 
          style="cursor:pointer; background:#444; border-radius:50%; padding:3px 8px; font-weight:bold; color:#0ff;"
          title="ErklÃ¤rung anzeigen">i</span>
  </div>

  <div id="breakevenInfoBox" style="display:none; background:#222; padding:12px; border-radius:8px; margin-top:10px; color:#ccc; font-size:14px; text-align:left;">
    <strong>â„¹ï¸ Was macht dieser Rechner?</strong><br><br>
    Der Break-even-Rechner zeigt dir den Preis, bei dem dein Trade exakt auf Null lÃ¤uft â€“ also weder Gewinn noch Verlust.<br><br>

    Dabei berÃ¼cksichtigt werden:
    <ul style="margin-top:10px; margin-bottom:10px;">
      <li><strong>ğŸ¯ Einstiegspreis:</strong> Der Preis, zu dem du den Trade geÃ¶ffnet hast.</li>
      <li><strong>ğŸ“ Spread:</strong> Unterschied zwischen Bid und Ask in Pips.</li>
      <li><strong>ğŸ’¸ GebÃ¼hren:</strong> z.â€¯B. Kommissionen des Brokers.</li>
      <li><strong>ğŸ§® LotgrÃ¶ÃŸe:</strong> Deine aktuelle PositionsgrÃ¶ÃŸe.</li>
      <li><strong>ğŸ’¡ Pip-Wert:</strong> Wert eines Pips pro Lot (z.â€¯B. 10â€¯â‚¬ bei Forex).</li>
    </ul>

    <strong>ğŸ“ Formel:</strong><br>
    <code style="color:#0ff;">Break-even = Einstiegspreis Â± (Spread + GebÃ¼hren Ã· (LotgrÃ¶ÃŸe Ã— Pip-Wert))</code><br><br>

    <em style="color:#aaa;">Ob du + oder â€“ rechnest, hÃ¤ngt davon ab, ob du Long oder Short bist. Dieser Rechner geht vom LONG-Trade aus.</em>
  </div>
</div>

<div id="calc-leverage" class="calc-box" style="display:none; margin-top: 15px;">
  <div class="stats-box">
    <label for="leverageMode">Berechnungsmodus:</label>
    <select id="leverageMode" onchange="toggleLeverageMode()">
      <option value="capital">ğŸ” Hebel âœ Kapital berechnen</option>
      <option value="lotcheck">ğŸ“Š Hebel + Kapital âœ Lotcheck</option>
    </select>

    <!-- MODUS 1: Hebel âœ Kapital -->
    <div id="capitalMode">
      <label for="leverageInput1">ğŸ“¦ Kapital (in â‚¬):</label>
      <input type="number" id="leverageInput1" placeholder="z.â€¯B. 500" />

      <label for="leverageInput2">ğŸ’¼ LotgrÃ¶ÃŸe:</label>
      <input type="number" id="leverageInput2" placeholder="z.â€¯B. 1.0" step="0.01" />

      <label for="leverageInput3">ğŸ“ˆ Hebel:</label>
      <input type="number" id="leverageInput3" placeholder="z.â€¯B. 10" step="1" />
    </div>

    <!-- MODUS 2: Hebel + Kapital âœ Lotcheck -->
    <div id="lotCheckMode" style="display:none">
  <label for="lotCapital">ğŸ“¦ Kapital (in â‚¬):</label>
  <input type="number" id="lotCapital" placeholder="z.â€¯B. 250" />

  <label for="lotLeverage">ğŸ’¡ Hebel (z.â€¯B. 500):</label>
  <input type="number" id="lotLeverage" placeholder="z.â€¯B. 500" />

  <label for="lotPair">ğŸ“Š WÃ¤hrungspaar:</label>
<select id="lotPair">
  <optgroup label="ğŸ” Forex">
    <option value="EUR/USD">EUR/USD</option>
    <option value="GBP/USD">GBP/USD</option>
    <option value="AUD/USD">AUD/USD</option>
    <option value="NZD/USD">NZD/USD</option>
    <option value="USD/CAD">USD/CAD</option>
    <option value="USD/CHF">USD/CHF</option>
    <option value="USD/JPY">USD/JPY</option>
    <option value="EUR/JPY">EUR/JPY</option>
    <option value="GBP/JPY">GBP/JPY</option>
    <option value="CHF/JPY">CHF/JPY</option>
    <option value="AUD/JPY">AUD/JPY</option>
    <option value="CAD/JPY">CAD/JPY</option>
    <option value="EUR/GBP">EUR/GBP</option>
    <option value="EUR/AUD">EUR/AUD</option>
    <option value="EUR/CAD">EUR/CAD</option>
    <option value="GBP/AUD">GBP/AUD</option>
    <option value="GBP/CAD">GBP/CAD</option>
  </optgroup>

  <optgroup label="ğŸ¥‡ Rohstoffe">
    <option value="XAU/USD">XAU/USD (Gold)</option>
    <option value="XAG/USD">XAG/USD (Silber)</option>
  </optgroup>

  <optgroup label="ğŸ’¹ Indizes">
    <option value="US30">US30 (Dow Jones)</option>
    <option value="NAS100">NAS100 (Nasdaq)</option>
    <option value="SPX500">SPX500 (S&P 500)</option>
    <option value="GER40">GER40 (DAX)</option>
    <option value="UK100">UK100 (FTSE)</option>
  </optgroup>

  <optgroup label="â‚¿ Krypto">
    <option value="BTC/USD">BTC/USD</option>
    <option value="ETH/USD">ETH/USD</option>
  </optgroup>
</select>

</div>

    <button onclick="calculateLeverage()">ğŸ”§ Berechnen</button>
    <p id="leverageResult" style="font-weight: bold; font-size: 18px; margin-top: 10px;"></p>
  </div>
</div>



  <!-- ğŸ“† Kalender -->
<div id="journalCalendarBox" class="stats-box" style="margin-top: 20px;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <button onclick="changeMonth(-1)">â¬…ï¸</button>
    <h3 id="calendarTitle">ğŸ—“ï¸ Journal-Kalender</h3>
    <button onclick="changeMonth(1)">â¡ï¸</button>
  </div>

  <canvas id="calendarEquityChart" height="150" style="margin:10px auto 5px auto; display:block;"></canvas>

  <div id="calendarEquityStats" style="color: #ccc; margin-top: 5px;"></div>
  <div id="calendarContainer" style="margin-top: 10px;"></div>
  <div id="calendarStats" style="margin-top: 5px; color: #ccc;"></div>
  <div id="journalEntryList" style="margin-top: 0;"></div>
</div>

<!-- ğŸ“˜ Journal-Eingabe -->
<div id="calc-journal" class="calc-box" style="display:none; margin-top: 10px;">
  <div class="stats-box" style="display: flex; flex-direction: column; gap: 14px; max-width: 500px; margin: auto; padding: 20px; border-radius: 12px; background: #1a1a1a; color: #eee;">

    <label>ğŸ§­ Strategie-Modus:</label>
    <select id="tradingMode" onchange="updateBiasOptions()" class="input" style="width: 100%;">

      <option value="day">Daytrading</option>
      <option value="swing">Swing-Trading</option>
    </select>

    <label>ğŸ“† Datum:</label>
    <input type="date" id="journalManualDate" class="input" style="width: 100%;" />

    <label>ğŸ’± Symbol:</label>
    <input type="text" id="journalSymbol" class="input" placeholder="z.â€¯B. EUR/USD" oninput="suggestSymbol()" autocomplete="off" style="width: 100%;" />
    <div id="symbolSuggestions" style="background:#222; color:white; padding:5px; display:none; border-radius:6px;"></div>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 130px;">
        <label>ğŸ¯ Einstieg:</label>
        <input type="number" id="journalEntry" class="input" style="width: 100%;" />
      </div>
      <div style="flex: 1; min-width: 130px;">
        <label>ğŸ Ausstieg:</label>
        <input type="number" id="journalExit" class="input" style="width: 100%;" />
      </div>
    </div>

    <label>ğŸ“ˆ Richtung:</label>
    <select id="journalDirection" class="input" style="width: 100%;">
      <option value="Long">Long</option>
      <option value="Short">Short</option>
    </select>

  <div style="display: flex; flex-direction: column; gap: 10px;">
<div>
  <label>ğŸ“¦ LotgrÃ¶ÃŸe:</label>
  <select id="journalLots" class="input" style="width: 100%; background-color: white; color: black;">
    <option value="">â€“ Bitte wÃ¤hlen â€“</option>
    <option value="0.01">0.01</option>
    <option value="0.02">0.02</option>
    <option value="0.03">0.03</option>
    <option value="0.05">0.05</option>
    <option value="0.10">0.10</option>
    <option value="0.25">0.25</option>
    <option value="0.50">0.50</option>
    <option value="1.00">1.00</option>
    <option value="2.00">2.00</option>
    <option value="3.00">3.00</option>
    <option value="5.00">5.00</option>
    <option value="10.00">10.00</option>
    <option value="25.00">25.00</option>
    <option value="50.00">50.00</option>
    <option value="100.00">100.00</option>
  </select>
</div>


  <div>
    <label>ğŸ“Š PnL (â‚¬):</label>
<input type="text"
       id="journalPnL"
       class="input"
       placeholder="z.â€¯B. -50.00"
       inputmode="numeric"
       pattern="^-?[0-9]+([.,][0-9]{1,2})?$"
       style="width: 100%; background-color: white; color: black;" />


  </div>
</div>


    <label>ğŸ˜ Fokus vor dem Trade:</label>
    <div id="starsBefore" class="star-rating" style="margin-bottom: 5px;"></div>
    <input type="hidden" id="emotionBefore" value="5" />

    <label>ğŸ˜¤ Nach dem Trade:</label>
    <div id="starsAfter" class="star-rating" style="margin-bottom: 5px;"></div>
    <input type="hidden" id="emotionAfter" value="5" />

    <label>ğŸ§  Setup:</label>
    <select id="journalSetup" class="input" style="width: 100%;">
      <option value="">â€“ Setup wÃ¤hlen â€“</option>
      <option value="Breakout">Breakout</option>
      <option value="Rejection">Rejection</option>
      <option value="Liquidity Grab">Liquidity Grab</option>
      <option value="News Spike">News Spike</option>
      <option value="Orderblock Reentry">Orderblock Reentry</option>
    </select>

<div id="setupBoxWrapper"
  style="margin-top: 10px; border-radius: 12px; padding: 16px;
         background: linear-gradient(135deg, #3d1e1e, #6b2f2f);
         border: 2px solid #aa3333;
         color: #eee;
         box-shadow: 0 0 8px rgba(255, 50, 50, 0.25);
         transition: all 0.3s ease;">

  <label style="font-weight: bold; font-size: 16px; display: block; margin-bottom: 10px;">âœ… Setup-Check</label>

  <label style="margin-top: 5px;">ğŸ§­ Multi-Timeframe Bias:</label>
  <div id="biasTimeframes" style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 14px;">
    <label><input type="checkbox" value="15M" onchange="updateSetupScoreDisplay()" /> 15M</label>
    <label><input type="checkbox" value="30M" onchange="updateSetupScoreDisplay()" /> 30M</label>
    <label><input type="checkbox" value="1H" onchange="updateSetupScoreDisplay()" /> 1H</label>
    <label><input type="checkbox" value="4H" onchange="updateSetupScoreDisplay()" /> 4H</label>
    <label><input type="checkbox" value="D1" onchange="updateSetupScoreDisplay()" /> D1</label>
    <label><input type="checkbox" value="W1" onchange="updateSetupScoreDisplay()" /> W1</label>
  </div>

<div id="ruleChecklist" style="display: flex; flex-direction: column; gap: 10px; font-size: 14px; margin-top:10px; color: #eee;">
  
  <label>
    <input type="checkbox" id="ruleAOI" onchange="updateSetupScoreDisplay()" />
    ğŸ§± AOI (z.â€¯B. 4H/D1 OB)
  </label>
  <small style="margin-left: 20px; color:#aaa;">
    â–¶ Preis reagiert klar sichtbar an Key-Zone (Orderblock, FVG, POI)
  </small>

  <label>
    <input type="checkbox" id="ruleEntry" onchange="updateSetupScoreDisplay()" />
    ğŸ¯ Entry-BestÃ¤tigung (z.â€¯B. Wick-Rejection)
  </label>
  <small style="margin-left: 20px; color:#aaa;">
    â–¶ Entry nach Rejection, Equal High/Low Raid, LTF Shift etc.
  </small>

  <label>
    <input type="checkbox" id="rulePsych" onchange="updateSetupScoreDisplay()" />
    ğŸ’¡ Psychologisches Level
  </label>
  <small style="margin-left: 20px; color:#aaa;">
    â–¶ 00/50-Level, Vorwochenhoch/-tief, runde Zahlen (z.â€¯B. 1900, 1950)
  </small>

  <label>
    <input type="checkbox" id="ruleSession" onchange="updateSetupScoreDisplay()" />
    ğŸ•’ Richtiges Zeitfenster
  </label>
  <small style="margin-left: 20px; color:#aaa;">
    â–¶ London Killzone (08:00â€“11:00) oder New York Killzone (14:30â€“17:00)
  </small>

  <label>
    <input type="checkbox" id="ruleRR" onchange="updateSetupScoreDisplay()" />
    ğŸ“ Min. 1:2.5 RR
  </label>
  <small style="margin-left: 20px; color:#aaa;">
    â–¶ Laut Struktur: erreichbares Ziel mindestens 2,5x SL-Distanz
  </small>

  <label>
    <input type="checkbox" id="ruleLTFShift" onchange="updateSetupScoreDisplay()" />
    ğŸ“‰ Strukturbruch / Shift
  </label>
  <small style="margin-left: 20px; color:#aaa;">
    â–¶ BOS / CHoCH auf M15 oder M5 â†’ tieferes Hoch oder tieferes Tief
  </small>

  <label>
    <input type="checkbox" id="ruleEntrySignal" onchange="updateSetupScoreDisplay()" />
    ğŸ¯ Einstiegsmuster sichtbar
  </label>
  <small style="margin-left: 20px; color:#aaa;">
    â–¶ z.â€¯B. Inside Bar, Breaker Block, Morning Star, Pinbar, Quasimodo
  </small>
</div>


  <div id="setupScoreDisplay" style="margin-top: 12px; font-size: 14px; font-weight: bold;">
    ğŸ“Š Setup-Score: <strong>0%</strong> â€“ âŒ Nicht gÃ¼ltig
  </div>

</div>


<label>ğŸ“ Kommentar <strong>vor dem Trade</strong>:</label>
<textarea id="journalNotesBefore" rows="2" class="input" style="border-radius: 6px;"></textarea>

<label>ğŸ“ Kommentar <strong>nach dem Trade</strong>:</label>
<textarea id="journalNotesAfter" rows="2" class="input" style="border-radius: 6px;"></textarea>

<!-- ğŸ“¸ Screenshot vor dem Trade -->
<label for="journalScreenshotBefore" style="margin-top: 10px;">ğŸ“¸ Screenshot <strong>vor dem Trade</strong> (optional):</label>
<input type="file" id="journalScreenshotBefore" accept="image/*" class="input" />

<!-- ğŸ“¸ Screenshot nach dem Trade -->
<label for="journalScreenshotAfter" style="margin-top: 10px;">ğŸ“¸ Screenshot <strong>nach dem Trade</strong> (optional):</label>
<input type="file" id="journalScreenshotAfter" accept="image/*" class="input" />

    
	<button id="saveJournalEntryButton" onclick="saveJournalEntry()" style="
      background-color: #0077cc;
      color: white;
      padding: 14px;
      border: none;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    ">ğŸ’¾ Eintrag speichern</button>
  </div>
</div>




<div style="margin-top:20px; text-align:center;">
  <button onclick="resetCurrentMonth()" style="margin:5px; background:#cc6600; color:white; padding:8px 15px; border:none; border-radius:5px;">ğŸ—“ï¸ Monat zurÃ¼cksetzen</button>
  <button onclick="resetSelectedDay()" style="margin:5px; background:#0066cc; color:white; padding:8px 15px; border:none; border-radius:5px;">ğŸ“… Tag zurÃ¼cksetzen</button>
  <button onclick="resetAllJournal()" style="margin:5px; background:#990000; color:white; padding:8px 15px; border:none; border-radius:5px;">ğŸ—‘ï¸ Alles lÃ¶schen</button>
</div>

<!-- ğŸ” Lightbox fÃ¼r vergrÃ¶ÃŸerte Bilder -->
<div id="lightboxOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999;" onclick="closeLightbox()">
  <img id="lightboxImage" src="" alt="Full Screenshot" style="max-width:90vw; max-height:90vh; border-radius:10px; box-shadow: 0 0 20px #000;" />
</div>




<div class="popup" id="resultPopup">
  <h3>Ergebnis</h3>
  <input type="text" inputmode="decimal" id="pnlInput" placeholder="z.â€¯B. 120.50" value="00,00" />
  <button onclick="saveResult()">Speichern</button>
</div>
<div id="syncStatus" style="text-align:center; color:#00ff99; font-weight:bold; margin-top:10px;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let currentMonthOffset = 0;
function onRuleChanged() {
  updateRuleCount();
  updateSetupScoreDisplay(); // ğŸ” Kein Delay mehr
}
function saveJournalEntry() {
  const fileBefore = document.getElementById("journalScreenshotBefore")?.files[0];
  const fileAfter = document.getElementById("journalScreenshotAfter")?.files[0];

  const manualDate = document.getElementById("journalManualDate")?.value;
  const tradingMode = document.getElementById("tradingMode")?.value || "day";
  const editId = document.getElementById("saveJournalEntryButton").dataset.editId;
  const allEntries = JSON.parse(localStorage.getItem("journalData") || "[]");

  const selectedBiasFrames = Array.from(document.querySelectorAll('#biasTimeframes input:checked'))
    .map(cb => cb.value);

  const entry = {
    id: editId ? parseInt(editId) : Date.now(),
    date: manualDate ? new Date(manualDate).toISOString() : new Date().toISOString(),
    pair: document.getElementById("journalSymbol").value.trim(),
    direction: document.getElementById("journalDirection").value,
    entry: parseFloat(document.getElementById("journalEntry").value),
    exit: parseFloat(document.getElementById("journalExit").value),
    lots: parseFloat(document.getElementById("journalLots").value),
pnl: parseFloat(document.getElementById("journalPnL").value.replace(",", ".")),


    emotionBefore: parseInt(document.getElementById("emotionBefore").value),
    emotionAfter: parseInt(document.getElementById("emotionAfter").value),
    tradingMode,
    biasTimeframes: selectedBiasFrames,
    ruleAOI: document.getElementById("ruleAOI")?.checked || false,
    ruleEntry: document.getElementById("ruleEntry")?.checked || false,
    rulePsych: document.getElementById("rulePsych")?.checked || false,
    ruleSession: document.getElementById("ruleSession")?.checked || false,
    ruleRR: document.getElementById("ruleRR")?.checked || false,
    ruleLTFShift: document.getElementById("ruleLTFShift")?.checked || false,
    ruleEntrySignal: document.getElementById("ruleEntrySignal")?.checked || false,
    notesBefore: document.getElementById("journalNotesBefore")?.value.trim(),
    notesAfter: document.getElementById("journalNotesAfter")?.value.trim(),
    screenshotBefore: null,
    screenshotAfter: null
  };

  const readerBefore = new FileReader();
  const readerAfter = new FileReader();
  let done = 0;

  const trySave = () => {
    done++;
    if (done === 2) {
      if (editId) {
        const index = allEntries.findIndex(e => e.id == editId);
        if (index !== -1) allEntries[index] = entry;
        delete document.getElementById("saveJournalEntryButton").dataset.editId;
      } else {
        allEntries.push(entry);
      }

      localStorage.setItem("journalData", JSON.stringify(allEntries));
      alert("âœ… Journal-Eintrag gespeichert!");
      buildJournalCalendar(currentMonthOffset);
      document.getElementById("calc-journal").style.display = "none";
    }
  };

  if (fileBefore) {
    readerBefore.onload = () => {
      entry.screenshotBefore = readerBefore.result;
      trySave();
    };
    readerBefore.readAsDataURL(fileBefore);
  } else {
    // Falls Bearbeiten und Screenshot vorher schon da:
    if (editId) {
      const oldEntry = allEntries.find(e => e.id == editId);
      if (oldEntry?.screenshotBefore) {
        entry.screenshotBefore = oldEntry.screenshotBefore;
      }
    }
    trySave();
  }

  if (fileAfter) {
    readerAfter.onload = () => {
      entry.screenshotAfter = readerAfter.result;
      trySave();
    };
    readerAfter.readAsDataURL(fileAfter);
  } else {
    if (editId) {
      const oldEntry = allEntries.find(e => e.id == editId);
      if (oldEntry?.screenshotAfter) {
        entry.screenshotAfter = oldEntry.screenshotAfter;
      }
    }
    trySave();
  }
}




function populateLotOptions() {
  const lotSelect = document.getElementById("journalLots");
  lotSelect.innerHTML = ""; // leeren

  const add = (val) => {
    const opt = document.createElement("option");
    opt.value = val.toFixed(2);
    opt.textContent = val.toFixed(2);
    lotSelect.appendChild(opt);
  };

  // Mikrolots (0.01 â€“ 0.09)
  for (let i = 1; i <= 9; i++) add(i / 100);

  // Mini bis Standardlots (0.10 â€“ 1.00)
  for (let i = 10; i <= 100; i += 5) add(i / 100);

  // GrÃ¶ÃŸere Schritte (1.00 â€“ 10.00)
  for (let i = 2; i <= 10; i++) add(i);

  // Noch grÃ¶ÃŸere Schritte (15 â€“ 100)
  for (let i = 15; i <= 100; i += 5) add(i);
}

function populateLotSuggestions() {
  const datalist = document.getElementById("lotOptions");
  datalist.innerHTML = "";

  const add = (val) => {
    const opt = document.createElement("option");
    opt.value = val.toFixed(2);
    datalist.appendChild(opt);
  };

  // 0.01 â€“ 0.10 (Scalping)
  for (let i = 1; i <= 10; i++) add(i / 100);

  // 0.10 â€“ 1.00 in 0.10er Schritten
  for (let i = 2; i <= 10; i++) add(i / 10);

  // 1.00 â€“ 10.00 in 1er Schritten
  for (let i = 1; i <= 10; i++) add(i);

  // 15 â€“ 100 in 5er Schritten
  for (let i = 15; i <= 100; i += 5) add(i);
}




function getSetupScore(entry) {
  const tfList = entry.biasTimeframes || [];
  const mode = entry.tradingMode || "day";

  // â— Mindestens 2 Bias-TFs erforderlich â†’ kein gÃ¼ltiger Entry
  if (tfList.length < 2) return { score: 0, valid: false };

  let score = 0;

  // âœ… Bias Timeframes (max 30â€¯%)
  score += Math.min(tfList.length, 3) * 10;

  // AOI (10â€¯%)
  if (entry.ruleAOI) score += 10;

  // AOI-Zeitframe korrekt (10â€¯%)
  const isAOICorrect =
    (mode === "swing" && tfList.includes("4H") && tfList.includes("D1")) ||
    (mode === "day" && tfList.includes("1H"));
  if (isAOICorrect) score += 10;

  // Entry Confirmation (10â€¯%)
  if (entry.ruleEntry) score += 10;

  // Psychologische Levels (5â€¯%)
  if (entry.rulePsych) score += 5;

  // Session-Zeitfenster (5â€¯%)
  if (entry.ruleSession) score += 5;

  // CRV erfÃ¼llt (5â€¯%)
  if (entry.ruleRR) score += 5;
  
  if (entry.ruleLTFShift) score += 10;
if (entry.ruleEntrySignal) score += 10;

  return {
    score: Math.min(score, 95),
    valid: true
  };
}


function openLightbox(src) {
  const overlay = document.getElementById("lightboxOverlay");
  const img = document.getElementById("lightboxImage");
  img.src = src;
  overlay.style.display = "flex";
}

function closeLightbox() {
  const overlay = document.getElementById("lightboxOverlay");
  const img = document.getElementById("lightboxImage");
  overlay.style.display = "none";
  img.src = "";
}

function updateBiasOptions() {
  const mode = document.getElementById("tradingMode")?.value || "day";
  const allowed = mode === "day" ? ["1H", "4H", "D1"] : ["4H", "D1", "W1"];

  document.querySelectorAll('#biasTimeframes input').forEach(cb => {
    const tf = cb.value;
    const label = cb.closest("label");
    if (allowed.includes(tf)) {
      label.style.display = "inline-flex";
    } else {
      cb.checked = false; // abwÃ¤hlen falls nicht erlaubt
      label.style.display = "none";
    }
  });

  updateSetupScoreDisplay(); // gleich aktualisieren
}


function getLiveSetupScoreFromForm() {
  const tfList = Array.from(document.querySelectorAll('#biasTimeframes input:checked')).map(cb => cb.value);
  const mode = document.getElementById("tradingMode")?.value || "day";

  let score = 0;

  // ğŸ“Œ Bias-Timeframes (max 3 TFs Ã  10â€¯%)
  score += Math.min(tfList.length, 3) * 10;

  // ğŸ“Œ AOI (Area of Interest)
  if (document.getElementById("ruleAOI")?.checked) score += 10;

  // ğŸ“Œ AOI-Timeframe korrekt (je nach Modus)
  const hasValidAOITF =
    (mode === "swing" && tfList.includes("4H") && tfList.includes("D1")) ||
    (mode === "day" && tfList.includes("1H"));
  if (hasValidAOITF) score += 10;

  // ğŸ“Œ Weitere Regelpunkte
  if (document.getElementById("ruleEntry")?.checked) score += 10;       // Entry Confirmation
  if (document.getElementById("rulePsych")?.checked) score += 5;        // Psych Level
  if (document.getElementById("ruleSession")?.checked) score += 5;      // Session
  if (document.getElementById("ruleRR")?.checked) score += 5;           // Risk:Reward
  if (document.getElementById("ruleLTFShift")?.checked) score += 10;    // LTF Shift
  if (document.getElementById("ruleEntrySignal")?.checked) score += 10; // Signal

  // ğŸ“Œ Endscore (A+ bei Day schon ab 85â€¯%)
  const cappedScore = Math.min(score, 95); // Maximal 95â€¯%
  const validBias = tfList.length >= 2;    // mindestens 2 Bias-TFs erforderlich

  return {
    score: cappedScore,
    validBias
  };
}





function updateSetupScoreDisplay() {
  const result = getLiveSetupScoreFromForm();
  const score = result.score;
  const hasBias = result.validBias;

  let verdict = "âŒ Nicht gÃ¼ltig (mind. 2 Bias-TFs)";
  let textColor = "#ff4444";

  if (hasBias && score >= 95) {
    verdict = "âœ… Perfekt";
    textColor = "#33ff77";
  } else if (hasBias && score >= 80) {
    verdict = "ğŸŸ¢ Sehr stark";
    textColor = "#55ff88";
  } else if (hasBias && score >= 60) {
    verdict = "ğŸŸ¨ Solide";
    textColor = "#ffff66";
  } else if (hasBias && score >= 40) {
    verdict = "ğŸŸ§ MittelmÃ¤ÃŸig";
    textColor = "#ffcc66";
  } else if (hasBias && score >= 20) {
    verdict = "ğŸŸ¥ Schwach";
    textColor = "#ff8888";
  } else if (hasBias) {
    verdict = "ğŸ”´ Katastrophal";
    textColor = "#ff4444";
  }

  // ğŸ” Farbverlauf fÃ¼r Box
  const wrapper = document.getElementById("setupBoxWrapper");
  if (score >= 95) {
    wrapper.style.background = "linear-gradient(135deg, #0d3c0d, #1f6b1f)";
    wrapper.style.borderColor = "#33aa33";
    wrapper.style.boxShadow = "0 0 8px rgba(50, 255, 100, 0.3)";
  } else if (score >= 80) {
    wrapper.style.background = "linear-gradient(135deg, #2f5e2f, #4cc94c)";
    wrapper.style.borderColor = "#55dd55";
    wrapper.style.boxShadow = "0 0 8px rgba(100, 255, 100, 0.25)";
  } else if (score >= 60) {
    wrapper.style.background = "linear-gradient(135deg, #706f1a, #a8d94c)";
    wrapper.style.borderColor = "#cccc55";
    wrapper.style.boxShadow = "0 0 8px rgba(220, 255, 100, 0.2)";
  } else if (score >= 40) {
    wrapper.style.background = "linear-gradient(135deg, #8f631a, #d9b24c)";
    wrapper.style.borderColor = "#ddaa55";
    wrapper.style.boxShadow = "0 0 8px rgba(255, 220, 100, 0.2)";
  } else if (score >= 20) {
    wrapper.style.background = "linear-gradient(135deg, #8f2f2f, #d94c4c)";
    wrapper.style.borderColor = "#cc5555";
    wrapper.style.boxShadow = "0 0 8px rgba(255, 100, 100, 0.2)";
  } else {
    wrapper.style.background = "linear-gradient(135deg, #3d1e1e, #6b2f2f)";
    wrapper.style.borderColor = "#aa3333";
    wrapper.style.boxShadow = "0 0 8px rgba(255, 50, 50, 0.25)";
  }

  let letterGrade = "F"; // Default

if (score >= 95) letterGrade = "A+";
else if (score >= 80) letterGrade = "A";
else if (score >= 60) letterGrade = "B";
else if (score >= 40) letterGrade = "C";
else if (score >= 20) letterGrade = "D";

// Ergebnis anzeigen mit Schatten
document.getElementById("setupScoreDisplay").innerHTML = `
  ğŸ“Š Setup-Score: <strong style="color:${textColor}; text-shadow: 0 0 2px black, 1px 1px 1px black;">
    ${score}% (${letterGrade})
  </strong> â€“ <span style="text-shadow: 0 0 2px black, 1px 1px 1px black;">${verdict}</span>
`;

}



updateSetupScoreDisplay();

function renderStars(value) {
  const v = Math.max(1, Math.min(10, parseInt(value) || 0));
  return "â­".repeat(v) + "â˜†".repeat(10 - v) + ` (${v}/10)`;
}

function setupStarRating(containerId, inputId) {
  const container = document.getElementById(containerId);
  const input = document.getElementById(inputId);

  for (let i = 10; i >= 1; i--) {
    const star = document.createElement("span");
    star.innerHTML = "â˜…";
    star.dataset.value = i;
    star.onclick = () => {
      input.value = i;
      updateStarVisuals(containerId, i);
    };
    container.appendChild(star);
  }

  updateStarVisuals(containerId, parseInt(input.value));
}

function updateStarVisuals(containerId, value) {
  const container = document.getElementById(containerId);
  const stars = container.querySelectorAll("span");
  stars.forEach(s => {
    s.classList.toggle("selected", parseInt(s.dataset.value) <= value);
  });
}

const knownSymbols = [
  // ğŸ”¹ Forex
  "EUR/USD", "GBP/USD", "USD/JPY", "USD/CHF", "AUD/USD", "NZD/USD", "USD/CAD",
  "EUR/JPY", "GBP/JPY", "CHF/JPY", "AUD/JPY", "CAD/JPY", "EUR/GBP", "EUR/CHF",
  "GBP/CHF", "AUD/NZD", "EUR/AUD", "EUR/CAD", "GBP/CAD", "GBP/NZD", "NZD/JPY", "NZD/CAD",

  // ğŸ”¹ Krypto (CFDs)
  "BTC/USD", "ETH/USD", "SOL/USD", "XRP/USD", "LTC/USD", "ADA/USD", "BCH/USD",

  // ğŸ”¹ Metalle (Spot & Futures CFDs)
  "XAU/USD", // Gold
  "XAG/USD", // Silber
  "XPT/USD", // Platin
  "XPD/USD", // Palladium
  "COPPER/USD", // Kupfer
  "ALUMINIUM/USD",
  "LEAD/USD",
  "ZINC/USD",

  // ğŸ”¹ Energie/Rohstoffe
  "WTI/USD",       // WTI Crude Oil
  "BRENT/USD",     // Brent Crude Oil
  "NATGAS/USD",    // Natural Gas
  "SOYBEAN/USD",   // Sojabohnen
  "SUGAR/USD",     // Zucker

  // ğŸ”¹ Indizes (zur Orientierung â€“ obwohl du nur 1â€“4 wolltest)
  "US30", "NAS100", "SPX500", "GER40", "UK100"
];


function suggestSymbol() {
  const input = document.getElementById("journalSymbol");
  const suggestionsBox = document.getElementById("symbolSuggestions");
  const query = input.value.toUpperCase().trim();

  if (!query || query.length < 1) {
    suggestionsBox.style.display = "none";
    suggestionsBox.innerHTML = "";
    return;
  }

  const matches = knownSymbols.filter(sym => sym.includes(query));
  suggestionsBox.innerHTML = matches.map(sym => `
    <div style="padding:4px; cursor:pointer;" onclick="selectSymbol('${sym}')">${sym}</div>
  `).join("");
  suggestionsBox.style.display = matches.length ? "block" : "none";
}

function selectSymbol(symbol) {
  document.getElementById("journalSymbol").value = symbol;
  document.getElementById("symbolSuggestions").style.display = "none";
  document.getElementById("symbolSuggestions").innerHTML = "";
}

function getPnLStatsByDay(entries) {
  const daily = {};
  entries.forEach(entry => {
    const date = new Date(entry.date).toISOString().split("T")[0];
    daily[date] = (daily[date] || 0) + (parseFloat(entry.pnl) || 0);
  });
  return daily;
}

function buildJournalCalendar(monthOffset = 0) {
  const now = new Date();
  const currentMonth = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  currentMonthOffset = monthOffset;

  const titleEl = document.getElementById("calendarTitle");
  if (titleEl) {
    titleEl.textContent = `ğŸ“… ${currentMonth.toLocaleString("de-DE", { month: "long" })} ${year}`;
  }

  const entries = JSON.parse(localStorage.getItem("journalData") || "[]");
  const dailyStats = getPnLStatsByDay(entries);
  const days = {};
  entries.forEach(e => {
    const d = new Date(e.date).toISOString().split("T")[0];
    days[d] = (days[d] || 0) + parseFloat(e.pnl || 0);
  });

  const greenDays = Object.values(days).filter(pnl => pnl > 0).length;
  const redDays = Object.values(days).filter(pnl => pnl < 0).length;
  const totalDays = greenDays + redDays;
  const greenRate = totalDays ? (greenDays / totalDays * 100).toFixed(1) : null;

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const manualDateInput = document.getElementById("journalManualDate");

  let activeCalendarCell = null;
  const calendar = document.createElement("div");
  calendar.style.display = "grid";
  calendar.style.gridTemplateColumns = "repeat(7, 1fr)";
  calendar.style.gap = "5px";

  ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"].forEach(day => {
    const d = document.createElement("div");
    d.textContent = day;
    d.style.textAlign = "center";
    d.style.color = "#0ff";
    calendar.appendChild(d);
  });

  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement("div"));
  }

for (let day = 1; day <= daysInMonth; day++) {
  const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
  const pnl = dailyStats[dateStr] || 0;

  const cell = document.createElement("div");
  cell.textContent = day;
  cell.style.padding = "10px";
  cell.style.borderRadius = "6px";
  cell.style.textAlign = "center";
  cell.style.cursor = "pointer";
  cell.style.transition = "outline 0.2s ease";

  const tradesOnDay = entries.filter(e => e.date.startsWith(dateStr));

  const withPnL = tradesOnDay.filter(e =>
    e.pnl !== undefined && e.pnl !== null && e.pnl !== "" && !isNaN(parseFloat(e.pnl))
  );
  const openTrades = tradesOnDay.length - withPnL.length;

  const pnls = withPnL.map(e => parseFloat(e.pnl));
  const hasGain = pnls.some(v => v > 0);
  const hasLoss = pnls.some(v => v < 0);

  // ğŸ¨ Farbentscheidung:
  if (openTrades > 0 && hasGain && hasLoss) {
    cell.style.background = "linear-gradient(135deg, #FFA500 33%, #228B22 33%, #228B22 66%, #B22222 66%)"; // Orange + GrÃ¼n + Rot
  } else if (openTrades > 0 && hasGain) {
    cell.style.background = "linear-gradient(135deg, #FFA500 50%, #228B22 50%)"; // Orange + GrÃ¼n
  } else if (openTrades > 0 && hasLoss) {
    cell.style.background = "linear-gradient(135deg, #FFA500 50%, #B22222 50%)"; // Orange + Rot
  } else if (openTrades > 0) {
    cell.style.background = "#FFA500"; // Nur offen
  } else if (hasGain && hasLoss) {
    cell.style.background = "linear-gradient(135deg, #228B22 50%, #B22222 50%)"; // GrÃ¼n + Rot
  } else {
    const sum = pnls.reduce((a, b) => a + b, 0);
    cell.style.background = sum > 0 ? "#228B22" : (sum < 0 ? "#B22222" : "#777"); // GrÃ¼n / Rot / Neutral
  }

  cell.style.color = "white";

  cell.onclick = () => {
    showEntriesForDate(dateStr);
    if (activeCalendarCell) activeCalendarCell.style.outline = "";
    cell.style.outline = "2px solid #3399ff";
    activeCalendarCell = cell;
    if (manualDateInput) manualDateInput.value = dateStr;

    const journalBox = document.getElementById("calc-journal");
    if (journalBox) {
      journalBox.style.display = "block";
      window.scrollTo({ top: journalBox.offsetTop - 40, behavior: "smooth" });
    }
  };

  calendar.appendChild(cell);
}



  document.getElementById("calendarContainer").innerHTML = "";
  document.getElementById("calendarContainer").appendChild(calendar);

  const currentMonthKey = `${year}-${String(month + 1).padStart(2, "0")}`;
  const monthlyEntries = entries
    .filter(e => e.date.startsWith(currentMonthKey))
    .sort((a, b) => new Date(a.date) - new Date(b.date));
	let validSetups = 0;
let shakySetups = 0;
let failedSetups = 0;

monthlyEntries.forEach(e => {
  const score = getSetupScore(e);
  if (score >= 40) validSetups++;
  else if (score >= 20) shakySetups++;
  else failedSetups++;
});


  // ğŸ“ˆ Equity-Kurve
  let equity = 0;
  let peak = 0;
  let maxDrawdown = 0;
  const equityData = [0];
  const labels = ['Start'];

  monthlyEntries.forEach((e, i) => {
    equity += parseFloat(e.pnl || 0);
    equityData.push(equity);
    labels.push(`#${i + 1}`);
    if (equity > peak) peak = equity;
    const dd = ((peak - equity) / peak) * 100;
    if (dd > maxDrawdown) maxDrawdown = dd;
  });

  const ctx = document.getElementById("calendarEquityChart").getContext("2d");
  if (window.calendarEquityChartInstance) window.calendarEquityChartInstance.destroy();
  window.calendarEquityChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Equity-Kurve',
        data: equityData,
        borderWidth: 2,
        borderColor: '#00ff99',
        backgroundColor: 'rgba(0,255,153,0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Trades im Monat' } },
        y: { title: { display: true, text: 'Kumulierte Performance (â‚¬)' } }
      },
      plugins: { legend: { display: false } }
    }
  });

  // ğŸ“Š Statistik
  const pnlPerDay = Object.values(days);
  const winTrades = monthlyEntries.filter(e => parseFloat(e.pnl) > 0);
  const lossTrades = monthlyEntries.filter(e => parseFloat(e.pnl) < 0);
  const totalWin = winTrades.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
  const totalLoss = lossTrades.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
  const avgPerDay = pnlPerDay.length ? pnlPerDay.reduce((a, b) => a + b, 0) / pnlPerDay.length : 0;
  const bestDay = pnlPerDay.length ? Math.max(...pnlPerDay) : null;
  const worstDay = pnlPerDay.length ? Math.min(...pnlPerDay) : null;
  const profitFactor = totalLoss !== 0 ? Math.abs(totalWin / totalLoss).toFixed(2) : "âˆ";
  const winRate = monthlyEntries.length > 0 ? (winTrades.length / monthlyEntries.length * 100).toFixed(1) : "â€“";

// ğŸ” Klassifikationstage vorbereiten
const rulesByDay = {}; // { "2025-07-23": [true, false, true] }

monthlyEntries.forEach(e => {
  const day = new Date(e.date).toISOString().split("T")[0];
  if (!rulesByDay[day]) rulesByDay[day] = [];
  rulesByDay[day].push([
    e.ruleBias ?? false,
    e.ruleSession ?? false,
    e.ruleSetupValid ?? false
  ]);
});

// Tagesklassifikation
let perfectDays = 0;
let shakyDays = 0;
let failDays = 0;

for (const ruleSets of Object.values(rulesByDay)) {
  let merged = [false, false, false];
  ruleSets.forEach(rules => {
    for (let i = 0; i < 3; i++) {
      merged[i] = merged[i] || rules[i]; // irgendeine Regel erfÃ¼llt zÃ¤hlt
    }
  });
  const count = merged.filter(x => x).length;
  if (count === 3) perfectDays++;
  else if (count >= 1) shakyDays++;
  else failDays++;
}


document.getElementById("calendarStats").innerHTML = `
  <div id="monthlyOverview" style="margin-bottom:15px;">
    ğŸ“… Monat ${currentMonthKey} â€“ <strong style="color:${equity >= 0 ? '#0f0' : '#f44'}">${equity.toFixed(2)} â‚¬</strong><br>
    ğŸ’š Bester Tag: <strong>${bestDay !== null ? bestDay.toFixed(2) : "â€“"} â‚¬</strong><br>
    ğŸ’” Schlechtester Tag: <strong>${worstDay !== null ? worstDay.toFixed(2) : "â€“"} â‚¬</strong><br>
    ğŸ“‰ Max Drawdown: <strong>${maxDrawdown.toFixed(2)}%</strong><br>
    ğŸ“ˆ Trades: <strong>${monthlyEntries.length}</strong><br>
    ğŸ§¾ Gewinn-Trades: <strong>${winTrades.length}</strong> / Verlust-Trades: <strong>${lossTrades.length}</strong><br>
    ğŸ§® Ã˜/Tag: <strong>${avgPerDay.toFixed(2)} â‚¬</strong><br>
    âš–ï¸ Profitfaktor: <strong>${profitFactor}</strong><br>
    ğŸ¯ Trefferquote: <strong>${winRate}%</strong><br><br>


    ğŸ§  <strong>Setup-Auswertung:</strong><br>
    âœ… Valide Setups: <strong>${validSetups}</strong><br>
    âš ï¸ Wacklige Setups: <strong>${shakySetups}</strong><br>
    âŒ Regelbruch-Setups: <strong>${failedSetups}</strong>
  </div>
`;

}

function changeMonth(offset) {
  currentMonthOffset += offset;
  buildJournalCalendar(currentMonthOffset);
}

function editEntry(entryId) {
  const all = JSON.parse(localStorage.getItem("journalData") || "[]");
  const entry = all.find(e => e.id === entryId);
  if (!entry) return alert("âŒ Eintrag nicht gefunden.");

// ğŸ§  Werte ins Formular laden
document.getElementById("journalManualDate").value = entry.date.split("T")[0];
document.getElementById("journalSymbol").value = entry.pair;
document.getElementById("journalDirection").value = entry.direction;
document.getElementById("journalEntry").value = entry.entry;
document.getElementById("journalExit").value = entry.exit;
document.getElementById("journalLots").value = entry.lots;
document.getElementById("journalPnL").value = entry.pnl;
document.getElementById("emotionBefore").value = entry.emotionBefore;
document.getElementById("emotionAfter").value = entry.emotionAfter;

// â­ Update Sternanzeige richtig anzeigen
updateStarVisuals("starsBefore", parseInt(entry.emotionBefore));
updateStarVisuals("starsAfter", parseInt(entry.emotionAfter));

// ğŸ“‹ Regeln (Checkliste) setzen
document.getElementById("ruleAOI").checked = !!entry.ruleAOI;
document.getElementById("ruleEntry").checked = !!entry.ruleEntry;
document.getElementById("rulePsych").checked = !!entry.rulePsych;
document.getElementById("ruleSession").checked = !!entry.ruleSession;
document.getElementById("ruleRR").checked = !!entry.ruleRR;
document.getElementById("ruleLTFShift").checked = !!entry.ruleLTFShift;
document.getElementById("ruleEntrySignal").checked = !!entry.ruleEntrySignal;
document.getElementById("journalNotesBefore").value = entry.notesBefore || "";
document.getElementById("journalNotesAfter").value = entry.notesAfter || "";
updateSetupScoreDisplay();
  // Regeln
  ["AOI", "Entry", "Psych", "Session", "RR", "LTFShift", "EntrySignal"].forEach(id => {
    const el = document.getElementById("rule" + id);
    if (el) el.checked = !!entry["rule" + id];
  });

  // Bias-TFs
  document.querySelectorAll('#biasTimeframes input').forEach(cb => {
    cb.checked = entry.biasTimeframes?.includes(cb.value) || false;
  });

  // Trading Mode
  document.getElementById("tradingMode").value = entry.tradingMode || "day";
  updateBiasOptions();

  // Score live anzeigen
  updateSetupScoreDisplay();

  // ğŸ§  Signal zum Ãœberschreiben statt neu anlegen
  document.getElementById("saveJournalEntryButton").dataset.editId = entryId;

  // Formular anzeigen
  document.getElementById("calc-journal").style.display = "block";
  window.scrollTo({ top: document.getElementById("calc-journal").offsetTop - 40, behavior: "smooth" });
}

function showEntriesForDate(dateStr) {
  const entries = JSON.parse(localStorage.getItem("journalData") || "[]");
  const filtered = entries.filter(e => e.date.startsWith(dateStr));
  const list = document.getElementById("journalEntryList");
  list.innerHTML = `<h4>ğŸ“… ${dateStr} â€“ ${filtered.length} Eintrag(e)</h4>`;

  if (filtered.length === 0) {
    list.innerHTML += "<p>âŒ Keine EintrÃ¤ge gefunden.</p>";
    return;
  }

  filtered.forEach(entry => {
    const result = getSetupScore(entry);
    const score = result.score;
    const valid = result.valid;

    let verdict = "âŒ Regelbruch";
    if (!valid) verdict = "âŒ Nicht gÃ¼ltig (Bias fehlt)";
    else if (score >= 95) verdict = "âœ… Perfekt";
    else if (score >= 80) verdict = "ğŸŸ¢ Sehr stark";
    else if (score >= 60) verdict = "ğŸŸ¨ Solide";
    else if (score >= 40) verdict = "ğŸŸ§ MittelmÃ¤ÃŸig";
    else if (score >= 20) verdict = "ğŸŸ¥ Schwach";

    const biasStr = entry.biasTimeframes?.join(" + ") || "â€“";
    const modeStr = entry.tradingMode || "â€“";

    const colorBox = entry.direction === "Long"
      ? "linear-gradient(135deg, #1e3d1e, #2f6b2f)"
      : "linear-gradient(135deg, #4a1e1e, #8b2f2f)";

    let pnlDisplay = "â³ Offen";
    let pnlSummaryColor = "#aa5500"; // Orange
    if (typeof entry.pnl === "number" && !isNaN(entry.pnl)) {
      pnlDisplay = `${entry.pnl} â‚¬`;
      pnlSummaryColor = entry.pnl > 0 ? "#1e5721" : entry.pnl < 0 ? "#8b2f2f" : "#666666";
    }

    const imgBefore = entry.screenshotBefore ? `
      <div style="text-align: center;">
        <div style="font-size: 12px; color: #ccc; margin-bottom: 4px;">ğŸ“¸ Vor dem Trade</div>
        <img src="${entry.screenshotBefore}" class="journal-screenshot" alt="Vor dem Trade" onclick="openLightbox('${entry.screenshotBefore}')" />
      </div>` : "";

    const imgAfter = entry.screenshotAfter ? `
      <div style="text-align: center;">
        <div style="font-size: 12px; color: #ccc; margin-bottom: 4px;">ğŸ“¸ Nach dem Trade</div>
        <img src="${entry.screenshotAfter}" class="journal-screenshot" alt="Nach dem Trade" onclick="openLightbox('${entry.screenshotAfter}')" />
      </div>` : "";

    list.innerHTML += `
      <details class="trade-box" style="margin-top: 10px; border-radius: 8px; overflow: hidden; background: ${colorBox};">
        <summary style="background: ${pnlSummaryColor}; color:#fff; padding: 8px 12px; font-weight: bold; cursor: pointer;">
          ${entry.pair} (${entry.direction}) â€“ ğŸ’° ${pnlDisplay}
        </summary>
        <div class="trade-details" style="background:#1a1a1a; color:#eee; padding: 12px;">
          ${renderStars(entry.emotionBefore)} Fokus<br>
          ${renderStars(entry.emotionAfter)} Nach dem Trade<br>
          ğŸ§­ Modus: <strong>${modeStr}</strong><br>
          ğŸ“ Bias-TFs: <strong>${biasStr}</strong><br>
          ğŸ“Š Setup Score: <strong>${score}%</strong> â€“ ${verdict}<br><br>

          <strong>ğŸ“ Kommentar vor dem Trade:</strong><br>
          ${entry.notesBefore || "â€“"}<br><br>

          <strong>ğŸ“ Kommentar nach dem Trade:</strong><br>
          ${entry.notesAfter || "â€“"}<br><br>

          <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-start; margin-top: 10px;">
            ${imgBefore}
            ${imgAfter}
          </div>

          <div style="display:flex; gap:10px; margin-top: 10px;">
  <button onclick="editEntry(${entry.id})"
          style="background:#0077cc; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">
    âœï¸ Bearbeiten
  </button>
  <button onclick="deleteEntry(${entry.id})"
          style="background:#cc3333; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">
    ğŸ—‘ï¸ LÃ¶schen
  </button>
</div>
        </div>
      </details>
    `;
  });
}



function deleteEntry(entryId) {
  if (!confirm("âŒ Diesen Eintrag wirklich lÃ¶schen?")) return;

  const all = JSON.parse(localStorage.getItem("journalData") || "[]");
  const updated = all.filter(e => e.id !== entryId);

  localStorage.setItem("journalData", JSON.stringify(updated));
  buildJournalCalendar(currentMonthOffset);
  document.getElementById("journalEntryList").innerHTML = "";
  alert("ğŸ—‘ï¸ Eintrag gelÃ¶scht.");
}



function resetCurrentMonth() {
  const entries = JSON.parse(localStorage.getItem("journalData") || "[]");
  const now = new Date();
  const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
  const filtered = entries.filter(e => !e.date.startsWith(monthKey));

  localStorage.setItem("journalData", JSON.stringify(filtered));
  buildJournalCalendar(currentMonthOffset);
  document.getElementById("journalEntryList").innerHTML = "";
  alert(`âœ… Alle EintrÃ¤ge fÃ¼r ${monthKey} wurden gelÃ¶scht.`);
}

function resetSelectedDay() {
  const selectedDate = document.getElementById("journalManualDate")?.value;
  if (!selectedDate) {
    alert("âš ï¸ Kein Tag ausgewÃ¤hlt.");
    return;
  }

  const entries = JSON.parse(localStorage.getItem("journalData") || "[]");
  const filtered = entries.filter(e => !e.date.startsWith(selectedDate));

  localStorage.setItem("journalData", JSON.stringify(filtered));
  buildJournalCalendar(currentMonthOffset);
  document.getElementById("journalEntryList").innerHTML = "";
  alert(`ğŸ“… Alle EintrÃ¤ge fÃ¼r ${selectedDate} wurden gelÃ¶scht.`);
}

function resetAllJournal() {
  if (confirm("âš ï¸ Bist du sicher, dass du ALLES lÃ¶schen willst?")) {
    localStorage.removeItem("journalData");
    localStorage.removeItem("manualNotes");

    buildJournalCalendar(currentMonthOffset);
    document.getElementById("journalEntryList").innerHTML = "";
    document.getElementById("calc-journal").style.display = "none";

    alert("ğŸ—‘ï¸ Journal vollstÃ¤ndig gelÃ¶scht.");
  }
}

window.addEventListener("DOMContentLoaded", () => {
  buildJournalCalendar();
  setupStarRating("starsBefore", "emotionBefore");
  setupStarRating("starsAfter", "emotionAfter");
  populateLotOptions();
  populateLotSuggestions();

  // Initial Setup-Score anzeigen, falls Bias ausgewÃ¤hlt ist
  if (document.querySelector('#biasTimeframes input:checked')) {
    updateSetupScoreDisplay();
  }
});

</script>

<script>
function calculatePositionSize() {
  const accountSize = parseFloat(document.getElementById("accountSize").value);
  const riskPercent = parseFloat(document.getElementById("riskPercent").value);
  const stopLossPips = parseFloat(document.getElementById("stopLossPips").value);
  const leverage = parseFloat(document.getElementById("leverage").value);
  const symbol = document.getElementById("symbolSelector").value;
  const manualLots = parseFloat(document.getElementById("manualLots")?.value);
  const resultEl = document.getElementById("positionSizeResult");

  const pipValues = {
    "XAU/USD": 100, "XAG/USD": 50,
    "BTC/USD": 30000, "ETH/USD": 1800,
    "US30": 10, "NAS100": 20, "SPX500": 10, "GER40": 25, "UK100": 10,
    "AUD/USD": 10, "EUR/USD": 10, "GBP/USD": 10, "NZD/USD": 10,
    "USD/CHF": 9.26, "USD/CAD": 7.94,
    "USD/JPY": 9.17, "EUR/JPY": 9.17, "GBP/JPY": 9.17,
    "CHF/JPY": 9.17, "AUD/JPY": 9.17, "NZD/JPY": 9.17, "CAD/JPY": 9.17,
    "EUR/GBP": 10, "EUR/AUD": 10, "EUR/CAD": 10,
    "GBP/AUD": 10, "GBP/CAD": 10, "AUD/CAD": 7.94
  };

  const basisWerte = {
    "XAU/USD": 200000, "XAG/USD": 125000, "BTC/USD": 30000, "ETH/USD": 1800,
    "US30": 10, "NAS100": 20, "SPX500": 10, "GER40": 25, "UK100": 10,
    "EUR/USD": 100000, "GBP/USD": 100000, "AUD/USD": 100000, "NZD/USD": 100000,
    "USD/CAD": 100000, "USD/CHF": 100000, "USD/JPY": 100000, "EUR/JPY": 100000,
    "GBP/JPY": 100000, "CHF/JPY": 100000, "AUD/JPY": 100000, "NZD/JPY": 100000,
    "CAD/JPY": 100000, "EUR/GBP": 100000, "EUR/AUD": 100000, "EUR/CAD": 100000,
    "GBP/AUD": 100000, "GBP/CAD": 100000, "AUD/CAD": 100000
  };

  const pipValueStandard = pipValues[symbol];
  const basis = basisWerte[symbol] || 100000;

  if (
    isNaN(accountSize) || isNaN(riskPercent) || isNaN(stopLossPips) ||
    isNaN(leverage) || accountSize <= 0 || riskPercent <= 0 ||
    stopLossPips <= 0 || leverage <= 0 || !pipValueStandard
  ) {
    resultEl.innerHTML = "âŒ Bitte alle Felder korrekt ausfÃ¼llen!";
    resultEl.style.color = "#f44";
    return;
  }

  const riskAmount = accountSize * (riskPercent / 100);
  let baseLot = riskAmount / (stopLossPips * (pipValueStandard));
  const maxLots = (accountSize * leverage) / basis;
  let output = "";

  if (0.01 > maxLots) {
    resultEl.innerHTML = `âŒ Mit diesem Hebel kannst du dir keine <strong>0.01 Lots</strong> leisten.<br>
      ğŸ“ Maximal erlaubt bei ${leverage}x Hebel: <strong>${maxLots.toFixed(4)} Lots</strong><br><br>
      Bitte Hebel oder Kapital erhÃ¶hen.`;
    resultEl.style.color = "#f44";
    return;
  }
const originalLot = baseLot;
  if (baseLot < 0.01) {
    output += `âš ï¸ Empfohlene GrÃ¶ÃŸe: <strong>${baseLot.toFixed(4)}</strong> Lots (unter 0.01)<br>`;
    output += `ğŸ”’ MindestgrÃ¶ÃŸe: 0.01 Lots â€“ Risiko kleiner als erwartet.<br><br>`;
    baseLot = 0.01;
  }

  // ğŸ“‰ Risiko korrekt berechnen mit pipValue angepasst an LotgrÃ¶ÃŸe
  const pipValueActual = pipValueStandard * baseLot;
  const risikoEuroEmpfohlen = stopLossPips * pipValueActual;
  const risikoProzentEmpfohlen = (risikoEuroEmpfohlen / accountSize) * 100;
  
  function getRiskComment(riskPercent) {
  if (riskPercent < 1) return "âœ… Sehr konservativ";
  if (riskPercent < 2) return "ğŸŸ¢ Konservativ";
  if (riskPercent < 5) return "ğŸŸ¡ Neutral";
  if (riskPercent < 10) return "ğŸŸ  ErhÃ¶htes Risiko";
  if (riskPercent < 20) return "ğŸ”´ Sehr hohes Risiko";
  return "ğŸ”¥ Extrem riskant â€“ nur fÃ¼r Profis!";
}

output += `<br>${getRiskComment(risikoProzentEmpfohlen)}<br><br>`;


 let risikoTitel = "ğŸ“‰ Dein Risiko:";
if (risikoProzentEmpfohlen >= 10) risikoTitel = "âš ï¸ Dein Risiko (nicht empfohlen):";
else if (risikoProzentEmpfohlen >= 5) risikoTitel = "ğŸŸ  Dein Risiko (grenzwertig):";
else if (risikoProzentEmpfohlen >= 2) risikoTitel = "ğŸŸ¡ Dein Risiko (moderat):";
else risikoTitel = "âœ… Dein Risiko (empfohlen):";

output += `<strong>${risikoTitel}</strong><br>`;
  output += `ğŸ’¸ <strong>${risikoEuroEmpfohlen.toFixed(2)}â€¯â‚¬</strong> (${risikoProzentEmpfohlen.toFixed(2)}â€¯% von ${accountSize}â€¯â‚¬)<br><br>`;

  const steps = [1, 2, 3, 4, 5];
  output += `âœ… Empfohlen: <strong>${(baseLot * steps[0]).toFixed(2)}</strong> Lots<br>`;
  output += `ğŸŸ¡ Riskant: ${(baseLot * steps[1]).toFixed(2)} Lots (Risiko ${(risikoProzentEmpfohlen * steps[1]).toFixed(1)}%)<br>`;
  output += `ğŸŸ¡ Riskant: ${(baseLot * steps[2]).toFixed(2)} Lots (Risiko ${(risikoProzentEmpfohlen * steps[2]).toFixed(1)}%)<br>`;
  output += `ğŸ”¥ Hoch: ${(baseLot * steps[3]).toFixed(2)} Lots (Risiko ${(risikoProzentEmpfohlen * steps[3]).toFixed(1)}%)<br>`;
  output += `ğŸ§® Sehr hoch: ${(baseLot * steps[4]).toFixed(2)} Lots (Risiko ${(risikoProzentEmpfohlen * steps[4]).toFixed(1)}%)<br>`;
  output += `âš ï¸ Mehr als ${(baseLot * steps[4]).toFixed(2)} Lots = Ã¼ber deinem Risiko-Limit<br><hr>`;
  output += `ğŸ“ Maximal erlaubt bei ${leverage}x Hebel: <strong>${maxLots.toFixed(2)} Lots</strong><br>`;

if (!isNaN(manualLots) && manualLots > 0) {
  const pipValueManuell = pipValueStandard * manualLots;
  const risikoEuroManuell = stopLossPips * pipValueManuell;
  const risikoProzentManuell = (risikoEuroManuell / accountSize) * 100;

  output += `<hr><strong>ğŸ“‰ Risiko bei manueller LotgrÃ¶ÃŸe (${manualLots}):</strong><br>`;
  output += `ğŸ’¸ <strong>${risikoEuroManuell.toFixed(2)}â€¯â‚¬</strong> (${risikoProzentManuell.toFixed(2)}â€¯% von ${accountSize}â€¯â‚¬)<br>`;
}


  resultEl.innerHTML = output;
  resultEl.style.color = "#0f0";
}












function toggleInfoBox() {
  const box = document.getElementById("posInfoBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}

function calculateLotFromFixed() {
  const riskEuro = parseFloat(document.getElementById("lotFixedRisk").value);
  const sl = parseFloat(document.getElementById("lotSL").value);
  const pipVal = parseFloat(document.getElementById("lotPipValue").value);
  const out = document.getElementById("lotResult");

  if (isNaN(riskEuro) || isNaN(sl) || isNaN(pipVal) ||
      riskEuro <= 0 || sl <= 0 || pipVal <= 0) {
    out.innerHTML = "âŒ Bitte alle Felder korrekt ausfÃ¼llen!";
    out.style.color = "#f44";
    return;
  }

  const lotSize = riskEuro / (sl * pipVal);

  out.innerHTML = `âœ… Empfohlene LotgrÃ¶ÃŸe: <strong>${lotSize.toFixed(2)}</strong> Lots`;
  out.style.color = "#0f0";
}

function toggleLotInfo() {
  const box = document.getElementById("lotInfoBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}


function togglePipMode() {
  const pipField = document.getElementById("riskPipValue");
  const tvNote = document.getElementById("tvNote");
  const checkbox = document.getElementById("useTradingView");

  if (checkbox.checked) {
    pipField.disabled = true;
    pipField.style.background = "#333";
    tvNote.style.display = "block";
  } else {
    pipField.disabled = false;
    pipField.style.background = "";
    tvNote.style.display = "none";
  }
}
function calculateRiskPercent() {
  const account = parseFloat(document.getElementById("riskAccountSize").value);
  const lot = parseFloat(document.getElementById("riskLotSize").value);
  const sl = parseFloat(document.getElementById("riskStopLoss").value);
  const useTV = document.getElementById("useTradingView").checked;
  const output = document.getElementById("riskResult");

  let pipVal = useTV ? 6.3 : parseFloat(document.getElementById("riskPipValue").value);

  if (
    isNaN(account) || isNaN(lot) || isNaN(sl) ||
    account <= 0 || lot <= 0 || sl <= 0 || isNaN(pipVal) || pipVal <= 0
  ) {
    output.innerHTML = "âŒ Bitte alle Felder korrekt ausfÃ¼llen!";
    output.style.color = "#f44";
    return;
  }

  const riskEuro = lot * sl * pipVal;
  const riskPercent = (riskEuro / account) * 100;

  output.innerHTML = `âš ï¸ Du riskierst <strong>${riskEuro.toFixed(2)} â‚¬</strong>  
                      (${riskPercent.toFixed(2)}â€¯% deines Kontos)`;
  output.style.color = riskPercent <= 2 ? "#0f0" : (riskPercent <= 5 ? "#ffaa00" : "#f44");
}


function toggleRiskInfo() {
  const box = document.getElementById("riskInfoBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}

function calculateBreakeven() {
  const entry = parseFloat(document.getElementById("entryPrice").value);
  const spread = parseFloat(document.getElementById("spreadPips").value);
  const fees = parseFloat(document.getElementById("fees").value);
  const lot = parseFloat(document.getElementById("beLotSize").value);
  const pipVal = parseFloat(document.getElementById("bePipValue").value);
  const output = document.getElementById("breakevenResult");

  if (isNaN(entry) || isNaN(spread) || isNaN(fees) || isNaN(lot) || isNaN(pipVal) ||
      entry <= 0 || spread < 0 || fees < 0 || lot <= 0 || pipVal <= 0) {
    output.innerHTML = "âŒ Bitte alle Felder korrekt ausfÃ¼llen!";
    output.style.color = "#f44";
    return;
  }

  const spreadValue = spread;
  const feeInPips = fees / (lot * pipVal);
  const totalPips = spreadValue + feeInPips;
  const pipSize = 0.0001; // FÃ¼r Forex (z.â€¯B. EUR/USD), ggf. anpassbar
  const breakEvenPrice = entry + (totalPips * pipSize);

  output.innerHTML = `ğŸ“ Break-even liegt bei <strong>${breakEvenPrice.toFixed(5)}</strong>`;
  output.style.color = "#0ff";
}

function toggleBreakevenInfo() {
  const box = document.getElementById("breakevenInfoBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}



function toggleLeverageMode() {
  const mode = document.getElementById("leverageMode").value;
  document.getElementById("capitalMode").style.display = mode === "capital" ? "block" : "none";
  document.getElementById("lotCheckMode").style.display = mode === "lotcheck" ? "block" : "none";
  document.getElementById("leverageResult").innerHTML = "";
}

function calculateLeverage() {
  const mode = document.getElementById("leverageMode").value;
  const resultEl = document.getElementById("leverageResult");

  if (mode === "capital") {
    const capital = parseFloat(document.getElementById("leverageInput1").value);
    const lots = parseFloat(document.getElementById("leverageInput2").value);
    const leverage = parseFloat(document.getElementById("leverageInput3").value);

    if (isNaN(capital) || isNaN(lots) || isNaN(leverage) || capital <= 0 || lots <= 0 || leverage <= 0) {
      resultEl.innerHTML = "âŒ Bitte alles korrekt eingeben!";
      resultEl.style.color = "#f44";
      return;
    }

    const benÃ¶tigtesKapital = (lots * 100000) / leverage;
    resultEl.innerHTML = `ğŸ“¦ Du brauchst <strong>${benÃ¶tigtesKapital.toFixed(2)} â‚¬</strong> Kapital fÃ¼r ${lots} Lot bei ${leverage}x Hebel`;
    resultEl.style.color = "#0f0";

  } else if (mode === "lotcheck") {
    const capital = parseFloat(document.getElementById("lotCapital").value);
    const leverage = parseFloat(document.getElementById("lotLeverage").value);
    const pair = document.getElementById("lotPair")?.value || "default";

    if (isNaN(capital) || isNaN(leverage) || capital <= 0 || leverage <= 0) {
      resultEl.innerHTML = "âŒ Bitte Kapital und Hebel korrekt eingeben!";
      resultEl.style.color = "#f44";
      return;
    }

let basis;
switch (pair) {
  // Metalle
 case "XAU/USD": basis = 200000; break;
case "XAG/USD": basis = 125000; break;

  // Krypto
  case "BTC/USD": basis = 30000; break;
  case "ETH/USD": basis = 1800; break;

  // Indizes
  case "US30":    basis = 10; break;
  case "NAS100":  basis = 20; break;
  case "SPX500":  basis = 10; break;
  case "GER40":   basis = 25; break;
  case "UK100":   basis = 10; break;

  // Forex mit typischer 100k KontraktgrÃ¶ÃŸe
  case "EUR/USD":
  case "GBP/USD":
  case "AUD/USD":
  case "NZD/USD":
  case "USD/CAD":
  case "USD/CHF":
    basis = 100000; break;

  // Forex mit leicht abweichendem Pip-Wert / Standard je nach Broker
  case "USD/JPY":
  case "EUR/JPY":
  case "GBP/JPY":
  case "CHF/JPY":
  case "AUD/JPY":
  case "CAD/JPY":
    basis = 100000; break; // Optional auf 1.000.000 JPY setzen, je nach Broker

  // Cross-Paare (ohne USD direkt)
  case "EUR/GBP":
  case "EUR/AUD":
  case "EUR/CAD":
  case "GBP/AUD":
  case "GBP/CAD":
    basis = 100000; break;

  default:
    basis = 100000; break; // Fallback fÃ¼r unbekannte Paare
}
   

    const maxLots = (capital * leverage) / basis;
    let output = `ğŸ’° <strong>Max. LotgrÃ¶ÃŸe (${pair}):</strong> ${maxLots.toFixed(2)} Lot<br><br>ğŸ“Š <strong>StÃ¼ckelung:</strong><br>`;

    const lotSizes = [1.00, 0.80, 0.50, 0.40, 0.20, 0.10, 0.01];
    lotSizes.forEach(size => {
      const times = Math.floor(maxLots / size);
      output += `â–¸ ${size.toFixed(2)} Lot = ${times > 0 ? times + "x" : "âŒ nicht mÃ¶glich"}<br>`;
    });

    resultEl.innerHTML = output;
    resultEl.style.color = "#0f0";
  }
}






function switchCalcTab(tab) {
  // Alle Rechner ausblenden
  document.querySelectorAll(".calc-box").forEach(box => {
    box.style.display = "none";
  });

  // Den gewÃ¼nschten Rechner einblenden
  const target = document.getElementById("calc-" + tab);
  if (target) target.style.display = "block";

  // Alle Buttons zurÃ¼cksetzen
  document.querySelectorAll(".tab-buttons .btn").forEach(btn => btn.classList.remove("active"));

  // Den aktiven Button markieren
  const btn = document.getElementById("btn-calc-" + tab);
  if (btn) btn.classList.add("active");
}



window.addEventListener("DOMContentLoaded", () => {
  initPipPairSelect();
});

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const sessionText = document.getElementById("sessionText");
const sessionProgressEl = document.getElementById("sessionProgressDisplay");
const sessionInfoEl = document.getElementById("sessionInfo");
const sessionDetailsBox = document.getElementById("sessionDetailsBox");
const alertBox = document.getElementById("alertBox");
const progressBar = document.getElementById("progressBar");
const progressContainer = document.querySelector(".progress-container");

sessionText.addEventListener("click", () => {
  sessionDetailsBox.style.display = sessionDetailsBox.style.display === "block" ? "none" : "block";
});

function formatHM(mins) {
  const h = Math.floor(mins / 60) % 24;
  const m = mins % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

const sessionColors = {
  Sydney: "#3388ff",
  Tokyo: "#00aaff",
  London: "#ffd700",
  "New York": "#ff4500",
  "London Killzone": "#ccff00",
  "New York Killzone": "#ff8800",
  Deadzone: "#333",
  Crypto: "#9900ff"  // ğŸ”¥ Jetzt mit Farbe!
};


const sessions = [
  {
    name: "Sydney",
    start: 1380,
    end: 480,
    info: "Ruhiger Markt, geringere LiquiditÃ¤t, Vorbereitung auf Asien.",
    weekDaysInfo: [
      { day: "Sonntag", text: "ğŸ› ï¸ Vorbereitung auf neue Woche" },
      { day: "Montag", text: "ğŸŒ Asien-Session startet" },
      { day: "Mittwoch", text: "ğŸ“Š Wirtschaftsdaten Australien" },
      { day: "Freitag", text: "ğŸ“… WÃ¶chentliche Analyse & Planung" }
    ],
  },
  {
    name: "Tokyo",
    start: 60,
    end: 600,
    info: "Moderate VolatilitÃ¤t, Fokus auf JPY/AUD/NZD, Breakouts mÃ¶glich.",
    weekDaysInfo: [
      { day: "Dienstag", text: "ğŸ¦ BoJ Pressekonferenz" },
      { day: "Donnerstag", text: "ğŸ“ˆ Japan BIP-Daten" },
      { day: "Freitag", text: "ğŸ‡ºğŸ‡¸ US NFP wirkt oft nach" }
    ],
  },
  {
    name: "London",
    start: 540,
    end: 1020,
    info: "Hohe LiquiditÃ¤t, starke Bewegungen, europÃ¤ische Wirtschaftsdaten.",
    weekDaysInfo: [
      { day: "Montag", text: "ğŸ“‰ EU Handelsdaten" },
      { day: "Dienstag", text: "ğŸ›ï¸ Zinsentscheidungen der EZB" },
      { day: "Donnerstag", text: "ğŸ“Š Inflationsdaten UK" },
      { day: "Freitag", text: "ğŸ“… Arbeitsmarktdaten UK" }
    ],
  },
  {
    name: "New York",
    start: 870,
    end: 1380,
    info: "Hohe VolatilitÃ¤t, US-Daten dominieren, Trendfortsetzungen mÃ¶glich.",
    weekDaysInfo: [
      { day: "Mittwoch", text: "ğŸ¦ Fed Zinsentscheidungen" },
      { day: "Freitag", text: "ğŸ“Š US NFP Arbeitsmarktdaten" },
      { day: "Freitag", text: "ğŸ“ˆ WÃ¶chentliche Arbeitslosenmeldung" }
    ],
  },
{
  name: "London Killzone",
  start: 420,
  end: 660,
  info: "Volatile Phase vor London-Open, Stop-Hunts mÃ¶glich.",
  weekDaysInfo: [
    { day: "Montag", text: "âš¡ Hohe VolatilitÃ¤t durch MarktÃ¶ffnung" },
    { day: "Mittwoch", text: "ğŸ”¥ Breakouts oft mÃ¶glich" }
  ],
},
{
  name: "New York Killzone",
  start: 810,
  end: 1020,
  info: "Start der NY Session, hohe AktivitÃ¤t, gute Chancen fÃ¼r Daytrader.",
  weekDaysInfo: [
    { day: "Dienstag", text: "âš¡ ErhÃ¶hte VolatilitÃ¤t durch US-Daten" },
    { day: "Donnerstag", text: "ğŸ™ï¸ Fed Reden & Daten" }
  ],
},
{
  name: "Deadzone",
  start: 1380,
  end: 0,
  info: "Niedrige VolatilitÃ¤t, SeitwÃ¤rtsbewegungen, Ruhephase.",
  weekDaysInfo: [
    { day: "TÃ¤glich", text: "ğŸ˜´ Markt ruhig, kaum Bewegung" }
  ],
},
{
  name: "Crypto",
  start: 0,
  end: 1440,
  info: "Krypto lÃ¤uft 24/7 â€“ Spitzenvolumen oft bei Ãœberschneidung mit NY & Asien.",
  weekDaysInfo: [
    { day: "Montag", text: "ğŸš€ Reaktion auf Wochenstart â€“ Gap-Moves checken" },
    { day: "Mittwoch", text: "ğŸ“‰ Midweek-Reversal bei BTC hÃ¤ufig" },
    { day: "Freitag", text: "ğŸ’¸ Ausbruch vor Wochenende, dann Flat Market" },
    { day: "Samstag", text: "ğŸ§˜ Wenig Volumen â€“ Fokus auf Konsolidierungen" },
    { day: "Sonntag", text: "â³ Pre-Move fÃ¼r Montag oft sichtbar" }
  ],
}
];



let lastAlertSession = null;

function getMinutesNow() {
  const now = new Date();
  return now.getHours() * 60 + now.getMinutes();
}

function getCurrentSessions(minNow) {
  return sessions.filter((s) => {
    const start = s.start;
    const end = s.end;
    if (start > end) {
      return minNow >= start || minNow < end;
    } else {
      return minNow >= start && minNow < end;
    }
  });
}

function updateGradientBar(colors) {
  if (colors.length === 0) {
    progressBar.style.background = "#444";
    progressBar.style.backgroundImage = "";
    return;
  }
  const svg = `
    <svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%'>
      <defs>
        <linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='0%'>
          ${colors.map((c, i) => `<stop offset='${(i / (colors.length - 1)) * 100}%' stop-color='${c}'/>`).join("")}
        </linearGradient>
      </defs>
      <rect x='0' y='0' width='100%' height='100%' fill='url(#g)'/>
    </svg>`;
  const base64 = btoa(svg);
  progressBar.style.backgroundImage = `url("data:image/svg+xml;base64,${base64}")`;
}

function hexToRgba(hex, alpha) {
  hex = hex.replace("#", "");
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function getMinutesToNextSession(minNow) {
  const futureStarts = sessions.map((s) => s.start).filter((start) => start > minNow);
  if (futureStarts.length === 0) return sessions[0].start + 1440 - minNow;
  return Math.min(...futureStarts) - minNow;
}

const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

function requestNotificationPermission() {
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission().then(permission => {
      console.log("ğŸ” Notification permission:", permission);
    });
  }
}






function showSessionProgress(activeSessions, currentMinutes) {
  let output = "";

  // ğŸ”¸ Aktuelle Session anzeigen
  if (activeSessions.length > 0) {
    const current = activeSessions[0];
    let start = current.start;
    let end = current.end;
    if (start > end) end += 1440;
    let nowMins = currentMinutes;
    if (nowMins < start) nowMins += 1440;
    const duration = end - start;
    const progressMins = nowMins - start;
    const percent = (progressMins / duration) * 100;
    const timeLeft = end - nowMins;

    output += `â±ï¸ Noch <strong>${formatHM(timeLeft)}</strong> in <strong>${current.name}</strong><br>`;
  } else {
    output += `â±ï¸ Aktuell <strong>keine Session aktiv</strong><br>`;
  }

  // ğŸ”œ NÃ¤chste Session anzeigen
  const futureSessions = sessions
    .map(s => ({
      ...s,
      startMins: s.start > currentMinutes ? s.start : s.start + 1440
    }))
    .sort((a, b) => a.startMins - b.startMins);

  const next = futureSessions[0];
  const minsToNext = next.startMins - currentMinutes;

  output += `ğŸ”œ NÃ¤chste: <strong>${next.name}</strong> in <strong>${formatHM(minsToNext)}</strong>`;

  // Ausgabe einfÃ¼gen
  sessionProgressEl.innerHTML = output;
}


function updateRealTimeBar() {
  const now = new Date();
  const weekday = now.getDay(); // Sonntag = 0, Samstag = 6
  const hours = String(now.getHours()).padStart(2, "0");
  const mins = String(now.getMinutes()).padStart(2, "0");
  const minutes = now.getHours() * 60 + now.getMinutes();
  const percent = (minutes / 1439) * 100;

  // Fortschrittsbalken immer aktualisieren
  progressBar.style.width = `${percent}%`;

  // âœ… Definiere echten Krypto-Wochenende-Zeitraum
  const isCryptoWeekend =
    (weekday === 6) || // Samstag
    (weekday === 0) || // Sonntag
    (weekday === 5 && minutes >= 1380); // Freitag ab 23:00

  if (isCryptoWeekend) {
    sessionText.textContent = `ğŸ•’ ${hours}:${mins} | Krypto-Wochenende aktiv`;
    sessionInfoEl.innerHTML = `
      ğŸ“´ Forex & Indizes geschlossen â€“
      <span class="crypto-animate">
        <span class="coin">ğŸª™</span> Krypto 24/7!
      </span>
    `;
    sessionProgressEl.innerHTML = "ğŸŸ¢ Aktive Crypto-Session â€“ Trade BTC, ETH & Co. jederzeit!";

    let weekendInfo = "";

    if (weekday === 5 && minutes >= 1380) {
      weekendInfo = `
        <strong>ğŸª™ Krypto ist aktiv (24/7)</strong><br>
        ğŸ“… <strong>Freitagabend:</strong><br>
        â€¢ ğŸ•– Letzte VolatilitÃ¤t vor dem Wochenschluss (18â€“22 Uhr)<br>
        â€¢ ğŸ” Take-Profits & Wochenschluss-Spikes<br>
        â€¢ ğŸ“‰ BTC oft rÃ¼cklÃ¤ufig durch PositionsschlieÃŸungen<br>
        â€¢ âš ï¸ Fakeouts & LiquiditÃ¤tsgrabs vor der Ruhephase<br><br>
        ğŸš€ Bereite deine Watchlist fÃ¼rs Wochenende vor!
      `;
    } else if (weekday === 6) {
      weekendInfo = `
        <strong>ğŸª™ Krypto ist aktiv (24/7)</strong><br>
        ğŸ“… <strong>Samstag:</strong><br>
        â€¢ ğŸ˜´ Niedriges Volumen â€“ kaum Institutionelle aktiv<br>
        â€¢ ğŸ”„ Meist SeitwÃ¤rtsphasen â†’ ideal fÃ¼r Range-Trading<br>
        â€¢ â„ï¸ Impulsarme MÃ¤rkte, gute Zeit fÃ¼r technische Analyse<br>
        â€¢ ğŸ“ Setups vorbereiten & Trading-Journal pflegen<br><br>
        ğŸ§˜ Fokus auf Klarheit statt Action â€“ perfekter Analyse-Tag.
      `;
    } else if (weekday === 0) {
      weekendInfo = `
        <strong>ğŸª™ Krypto ist aktiv (24/7)</strong><br>
        ğŸ“… <strong>Sonntag:</strong><br>
        â€¢ â³ Pre-Move-Phase startet oft ab 18â€“20 Uhr<br>
        â€¢ ğŸ§  Smart Money beginnt Positionierung fÃ¼r Montag<br>
        â€¢ ğŸª¤ False Breakouts oder â€Liquidity Sweepsâ€œ typisch<br>
        â€¢ ğŸ”¥ Volumen steigt spÃ¼rbar, besonders vor News-Wochen<br><br>
        ğŸš€ Nutze den Sonntagabend fÃ¼r Setup-Feintuning & Ausblick!
      `;
    }

    sessionDetailsBox.innerHTML = weekendInfo;
    return; // ğŸ‘‰ Verhindert normale Session-Anzeige
  }


  // â¬ Werktag-Session-Logik
  const activeSessions = getCurrentSessions(minutes);
  const names = activeSessions
  .map(s => s.name)
  .filter(n => n !== "Crypto"); // ğŸ”¥ Crypto wird vom Balken ausgeschlossen

  const activeNames = names.length > 0 ? `| Aktive Session: ${names.join(" + ")}` : "| Keine Session aktiv";
  sessionText.textContent = `ğŸ•’ ${hours}:${mins} ${activeNames}`;

  const colors = names.map(n => sessionColors[n] || "#666");
  updateGradientBar(colors);
  showSessionProgress(activeSessions, minutes);

  progressContainer.style.boxShadow = colors.length > 0
    ? `0 0 12px 6px ${hexToRgba(colors[0], 0.6)}`
    : "0 0 12px 6px rgba(0,0,0,0)";

  const name = activeSessions.length > 0 ? activeSessions[0].name : "";
  let infoText = "Keine aktiven Sessions â€“ Markt wahrscheinlich ruhig.";

  if (name === "Tokyo") {
    infoText = minutes < 180 ? "ğŸŒ Tokyo erÃ¶ffnet â€“ erste Bewegungen durch asiatische HÃ¤ndler." :
                minutes < 360 ? "ğŸ‡¯ğŸ‡µ Asiatische VolatilitÃ¤t aktiv â€“ mÃ¶gliche Bewegungen bei JPY." :
                "ğŸ›‘ Tokyo flacht ab â€“ Fokus wechselt langsam nach Europa.";
  } else if (name === "London Killzone") {
    infoText = "âš ï¸ London Killzone â€“ hohe VolatilitÃ¤t & starke Bewegungen mÃ¶glich.";
  } else if (name === "London") {
    infoText = minutes < 720 ? "ğŸ’· London Session â€“ Markt in Bewegung, europÃ¤ische Daten entscheidend." :
                minutes < 840 ? "ğŸ˜´ Mittagliche Deadzone â€“ Markt konsolidiert hÃ¤ufig, Vorsicht bei Entries." :
                "ğŸ“ˆ London-Teilnehmer bleiben aktiv â€“ Vorbereitung auf NY.";
  } else if (name === "New York Killzone") {
    infoText = "ğŸ”¥ New York Killzone â€“ starke Reaktionen auf US-News & Breakouts mÃ¶glich.";
  } else if (name === "New York") {
    infoText = minutes < 1080 ? "ğŸ‡ºğŸ‡¸ New York Session â€“ starker US-Einfluss, Trendfortsetzungen mÃ¶glich." :
                minutes < 1200 ? "ğŸ“‰ New York flacht ab â€“ Markt beruhigt sich langsam." :
                "ğŸŒƒ New York Session endet â€“ geringe Bewegung, Vorsicht bei Entries.";
  } else if (name === "Crypto") {
    if (weekday === 6) {
      infoText = "ğŸ§˜ Samstag â€“ ruhige Konsolidierungen, optimal fÃ¼r Range-Trading.";
    } else if (weekday === 0) {
      infoText = minutes < 1080 ? "ğŸ˜´ Sonntagvormittag â€“ flacher Markt, aber Pre-Move kann sich aufbauen." :
                  "â³ Sonntagabend â€“ mÃ¶gliche Pre-Moves vor dem Forex-Start.";
    } else if (weekday === 5 && minutes >= 1080) {
      infoText = "ğŸ’¸ Freitagabend â€“ letzte VolatilitÃ¤t, oft BTC-AusbrÃ¼che vor dem Wochenende.";
    } else {
      infoText = "ğŸª™ Krypto lÃ¤uft 24/7 â€“ typischer Fokus: BTC/ETH & News-getriebene Altcoins.";
    }
  } else if (minutes >= 720 && minutes < 840) {
    infoText = "ğŸ˜´ Mittagliche Deadzone â€“ Markt konsolidiert hÃ¤ufig, Vorsicht bei Entries.";
  } else if (minutes >= 1380 || minutes < 60) {
    infoText = "ğŸŒ™ Nacht-Deadzone â€“ Markt ist extrem ruhig, keine relevanten Bewegungen.";
  }

  sessionInfoEl.textContent = infoText;

  // ğŸ“‹ Aktive Session-Details + Wochentagstexte
  if (activeSessions.length > 0) {
    let fullInfo = "";

    activeSessions.forEach(s => {
      let weekDaysHtml = "";
      if (s.weekDaysInfo) {
        weekDaysHtml = "<ul style='margin-left:18px; margin-top:4px;'>";
        s.weekDaysInfo.forEach(({ day, text }) => {
          weekDaysHtml += `<li><strong>${day}:</strong> ${text}</li>`;
        });
        weekDaysHtml += "</ul>";
      }

      const label = s.name.includes("Killzone") ? "ğŸ”¥" :
                    s.name.includes("New York") ? "ğŸ‡ºğŸ‡¸" :
                    s.name.includes("London") ? "ğŸ’·" :
                    s.name.includes("Tokyo") ? "ğŸŒ" :
                    s.name.includes("Sydney") ? "ğŸŒ™" :
                    s.name.includes("Crypto") ? "ğŸª™" : "ğŸŸ¡";

      fullInfo += `
        <strong>${label} ${s.name}</strong><br>
        ğŸ“… Start: ${formatHM(s.start)} Uhr<br>
        ğŸ•“ Ende: ${formatHM(s.end)} Uhr<br>
        â„¹ï¸ ${s.info}
        ${weekDaysHtml}
        <hr style="border: none; border-top: 1px solid #444; margin: 10px 0;">
      `;
    });

    sessionDetailsBox.innerHTML = fullInfo;
  } else {
    sessionDetailsBox.innerHTML = "Keine aktive Session â€“ Markt ist ruhig.";
  }

  // â° Session-Wechsel-Warnung
  const minutesToNext = getMinutesToNextSession(minutes);
  if (minutesToNext <= 5 && minutesToNext > 0) {
    const currentActive = sessionText.textContent;
    if (lastAlertSession !== currentActive) {
      showAlert(`âš ï¸ Session-Wechsel in 5 Minuten!`);
      lastAlertSession = currentActive;

      if (activeSessions.length > 0) {
        const s = activeSessions[0];
        showSessionStartNotification(s.name, s.info);
      }
    }
  } else {
    lastAlertSession = null;
  }
}



function updateDaySummary() {
  const days = ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"];
  const infos = {
    "Montag": `
ğŸš€ Start in die Woche â€“ neue Impulse, frische Trends mÃ¶glich.
ğŸª™ Krypto oft ruhig nach Sonntag â€“ Fokus auf BTC-Reaktion.
    `,
    "Dienstag": `
ğŸ“ˆ Trend-Fortsetzung oder technische Korrekturen im Forex.
ğŸª™ BTC & Altcoins reagieren oft auf Marktstimmung.
    `,
    "Mittwoch": `
âš ï¸ Midweek-Reversal mÃ¶glich â€“ Vorsicht bei Trendwechseln.
ğŸª™ BTC hÃ¤ufig impulsiv â€“ Fakeouts nicht selten.
    `,
    "Donnerstag": `
ğŸ“Š News-Donnerstag â€“ viele Wirtschaftsreleases.
ğŸª™ Volatile Altcoins â€“ gute Chancen fÃ¼r Breakouts.
    `,
    "Freitag": `
ğŸ“… Wochenabschluss â€“ Gewinne sichern, keine Paniktrades.
ğŸª™ Abends oft BTC-VolatilitÃ¤t vor dem Krypto-Wochenende.
    `,
    "Samstag": `
ğŸ“´ Forex geschlossen â€“ Markt schlÃ¤ft.
ğŸª™ Nur Krypto aktiv â€“ ideale Zeit fÃ¼r Range-Trading & Analyse.
    `,
    "Sonntag": `
ğŸ› ï¸ Vorbereitung auf neue Woche â€“ Forex inaktiv.
ğŸª™ BTC Pre-Move oft ab 18â€“20 Uhr â€“ Setup planen!
    `
  };


  const now = new Date();
  const dayIndex = now.getDay();
  const dayName = days[dayIndex];
  const info = infos[dayName] || "ğŸ“† Trading-Tag";

  const el = document.getElementById("daySummary");
  el.textContent = `ğŸ—“ï¸ ${dayName} â€“ ${info}`;
}

document.addEventListener("DOMContentLoaded", () => {
  const daySummaryEl = document.getElementById("daySummary");
  const dayDetailsEl = document.getElementById("dayDetails");
const dayDetailsMap = {
  "Montag": `
ğŸ”µ <strong>Montag</strong><br><br>
<strong>ğŸ“Œ Setup:</strong><br>
Wochenstart â€“ noch keine klare Richtung. Fokus auf erste LiquiditÃ¤tsreaktionen.<br><br>

<strong>âœ… Strategie:</strong><br>
Vorsichtiger Einstieg nach London-Open (09:00â€“10:00 Uhr)<br><br>

<strong>ğŸ•“ Marktverhalten:</strong><br>
Volumen steigt langsam an â€“ viele Trader warten auf Dienstag.<br><br>

<strong>ğŸ“Š Wirtschaftsdaten:</strong><br>
<ul>
  <li>ğŸ‡ªğŸ‡º EU-Handelsdaten, Sentiment-Indikatoren</li>
  <li>ğŸ’¬ Kaum US-Daten â€“ NY-Session eher trÃ¤ge</li>
</ul><br>

<strong>ğŸ§  Mentaler Fokus:</strong><br>
Geduldig bleiben â€“ erste Impulse beobachten.<br><br>

<strong>ğŸ§¾ To-do am Montag:</strong><br>
<ul>
  <li>ğŸ“… Wochenziele notieren</li>
  <li>ğŸ“ˆ H1/H4 Bias eintragen</li>
</ul><br>

<strong>ğŸª™ Krypto-Notiz:</strong><br>
BTC reagiert oft trÃ¤ge nach dem Wochenende â€“ Strukturaufbau bis Montagabend.<br>
ETH/BTC-Paare zeigen erste Signale fÃ¼r VolatilitÃ¤t der Woche.
`,

  "Dienstag": `
ğŸŸ¢ <strong>Dienstag</strong><br><br>
<strong>ğŸ“Œ Setup:</strong><br>
Intraday-Trading meist am klarsten â€“ oft Trendfortsetzung oder Retest.<br><br>

<strong>âœ… Strategie:</strong><br>
Nutze saubere Marktstruktur â†’ Breakouts + Retest mÃ¶glich.<br><br>

<strong>ğŸ•“ Marktverhalten:</strong><br>
Konstant â€“ London & NY liefern gute Bewegungen.<br><br>

<strong>ğŸ“Š Wirtschaftsdaten:</strong><br>
<ul>
  <li>ğŸ‡ªğŸ‡º EZB oder UK Reden mÃ¶glich</li>
  <li>ğŸ‡ºğŸ‡¸ US-Einstiegsdaten</li>
</ul><br>

<strong>ğŸ§  Mentaler Fokus:</strong><br>
Keine Hektik â€“ Struktur traden.<br><br>

<strong>ğŸ§¾ To-do am Dienstag:</strong><br>
<ul>
  <li>âš™ï¸ Trade-Log abgleichen</li>
  <li>ğŸ““ Swing-Kandidaten markieren</li>
</ul><br>

<strong>ğŸª™ Krypto-Notiz:</strong><br>
BTC/ETH ziehen meist am Dienstag an â€“ viele Altcoins folgen.<br>
Guter Tag fÃ¼r FVG/Breaker-Entry in Krypto.
`,

  "Mittwoch": `
ğŸŸ¡ <strong>Mittwoch</strong><br><br>
<strong>ğŸ“Œ Setup:</strong><br>
Midweek-Reversal â€“ viele FehlausbrÃ¼che mÃ¶glich.<br><br>

<strong>âœ… Strategie:</strong><br>
Reversal-Potenziale beachten, Killzones gezielt handeln.<br><br>

<strong>ğŸ•“ Marktverhalten:</strong><br>
VolatilitÃ¤t steigt â€“ Intraday-Highs/Lows werden geholt.<br><br>

<strong>ğŸ“Š Wirtschaftsdaten:</strong><br>
<ul>
  <li>ğŸ¦ FOMC/Fed Minutes</li>
  <li>ğŸ‡ªğŸ‡º EU/UK Inflationsdaten</li>
</ul><br>

<strong>ğŸ§  Mentaler Fokus:</strong><br>
Flexibel bleiben â€“ Bias kann kippen.<br><br>

<strong>ğŸ§¾ To-do am Mittwoch:</strong><br>
<ul>
  <li>ğŸ“ˆ Midweek-Revue</li>
</ul><br>

<strong>ğŸª™ Krypto-Notiz:</strong><br>
BTC macht oft genau am Mittwoch seine Wochenrichtung klar oder Fake-Move â€“ Fokus auf LiquiditÃ¤tszonen.
`,

  "Donnerstag": `
ğŸŸ  <strong>Donnerstag</strong><br><br>
<strong>ğŸ“Œ Setup:</strong><br>
Momentum-Tag â€“ viele Impulse durch News.<br><br>

<strong>âœ… Strategie:</strong><br>
NY-Killzone aktiv handeln â€“ Fokus auf USD, Gold, NAS100.<br><br>

<strong>ğŸ•“ Marktverhalten:</strong><br>
London & NY klar â€“ guter Trend-Tag.<br><br>

<strong>ğŸ“Š Wirtschaftsdaten:</strong><br>
<ul>
  <li>ğŸ‡ºğŸ‡¸ GDP, PCE, CPI</li>
</ul><br>

<strong>ğŸ§  Mentaler Fokus:</strong><br>
Mutig, aber sauber â€“ Reaktionen abwarten.<br><br>

<strong>ğŸ§¾ To-do am Donnerstag:</strong><br>
<ul>
  <li>ğŸ§  Gewinne sichern</li>
</ul><br>

<strong>ğŸª™ Krypto-Notiz:</strong><br>
Donnerstag ist oft der â€Catch-up-Tagâ€œ fÃ¼r Altcoins â€“ hohe Dynamik bei Krypto-Volumen im NY-Overlap.
`,

  "Freitag": `
ğŸ”´ <strong>Freitag</strong><br><br>
<strong>ğŸ“Œ Setup:</strong><br>
Scalping & Intraday â€“ groÃŸe Bewegungen meist vorbei.<br><br>

<strong>âœ… Strategie:</strong><br>
Nur LiquiditÃ¤tsjagden handeln â€“ keine blind Breakouts.<br><br>

<strong>ğŸ•“ Marktverhalten:</strong><br>
Ruhiger ab 13:00 Uhr â€“ PositionsschlieÃŸung dominiert.<br><br>

<strong>ğŸ“Š Wirtschaftsdaten:</strong><br>
<ul>
  <li>ğŸ“ˆ US-Arbeitsmarktdaten (oft 14:30 Uhr)</li>
</ul><br>

<strong>ğŸ§  Mentaler Fokus:</strong><br>
Kein FOMO, kein Revenge-Trading.<br><br>

<strong>ğŸ§¾ To-do am Freitag:</strong><br>
<ul>
  <li>ğŸ“Š Wochenstatistik eintragen</li>
</ul><br>

<strong>ğŸª™ Krypto-Notiz:</strong><br>
Ab 18:00 Uhr: BTC beginnt Pre-Move fÃ¼r Wochenende.<br>
BTC/ETH brechen oft vor dem â€Krypto-Samstagâ€œ aus â€“ Watchlist ready machen.
`,

  "Samstag": `
ğŸ“´ <strong>Samstag</strong><br><br>
Kein Handel in Forex â€“ aber Krypto lÃ¤uft.<br><br>

<strong>ğŸª™ Krypto-Notiz:</strong><br>
â€¢ Wenig Volumen â€“ ideal fÃ¼r Struktur-Analyse<br>
â€¢ Range-Trading auf BTC/ETH sehr effektiv<br>
â€¢ Vorbereitung auf Sonntag â†’ Pre-Move beachten
`,

  "Sonntag": `
ğŸ“´ <strong>Sonntag</strong><br><br>
Noch kein Handel in Forex â€“ aber wichtigster Vorbereitungstag.<br><br>

<strong>ğŸª™ Krypto-Notiz:</strong><br>
â€¢ Ab 18:00 Uhr: BTC/ETH zeigen oft erste Richtung<br>
â€¢ Pre-Move fÃ¼r die Woche sichtbar<br>
â€¢ Setups validieren & Einstiegslevel berechnen
`
};


  if (daySummaryEl && dayDetailsEl) {
    daySummaryEl.addEventListener("click", () => {
      const now = new Date();
      const dayName = ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"][now.getDay()];
      const content = dayDetailsMap[dayName] || "ğŸ“† Keine Details fÃ¼r diesen Tag.";

      const visible = dayDetailsEl.style.display === "block";
      dayDetailsEl.style.display = visible ? "none" : "block";
      if (!visible) dayDetailsEl.innerHTML = content;
    });
  }

  updateDaySummary();
});




window.addEventListener("load", () => {
  requestNotificationPermission();
  updateRealTimeBar();
  updateDaySummary(); // ğŸ“… Wochentag-Anzeige aktualisieren

  setInterval(updateRealTimeBar, 60000);
});
</script>



<script>
// âœ… Service Worker Registrierung
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("sw.js")
      .then(reg => console.log("âœ… Service Worker registriert:", reg))
      .catch(err => console.error("âŒ SW Registrierung fehlgeschlagen:", err));
  });
}

// âœ… App-Install Trigger mit Button
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  console.log("ğŸŸ¡ beforeinstallprompt ausgelÃ¶st");
  e.preventDefault();
  deferredPrompt = e;
  showInstallButton();
});

function showInstallButton() {
  if (localStorage.getItem("installPromptHandled") === "true") return;
  if (document.getElementById("installBtn")) return;

  const installBtn = document.createElement("button");
  installBtn.id = "installBtn";
  installBtn.textContent = "ğŸ“² App installieren";
  installBtn.className = "big-btn";
  installBtn.style.position = "fixed";
  installBtn.style.bottom = "80px";
  installBtn.style.left = "50%";
  installBtn.style.transform = "translateX(-50%)";
  installBtn.style.zIndex = "9999";
  document.body.appendChild(installBtn);

  installBtn.addEventListener("click", () => {
    installBtn.remove();
    localStorage.setItem("installPromptHandled", "true"); // âœ… Nur einmal fragen
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        console.log("ğŸ“¥ Installationswahl:", choiceResult.outcome);
        deferredPrompt = null;
      });
    }
  });
}

// ğŸ•’ Fallback-Check nach 3 Sekunden, ob der Button angezeigt werden kann
setTimeout(() => {
  if (deferredPrompt) {
    showInstallButton();
  } else {
    console.log("âŒ Kein Install-Event verfÃ¼gbar");
  }
}, 3000);
</script>

<script>
function sendPushNotification(title, message) {
  if ("Notification" in window && Notification.permission === "granted" && "serviceWorker" in navigator) {
    navigator.serviceWorker.ready.then((registration) => {
      registration.showNotification(title, {
        body: message,
        icon: "https://cdn-icons-png.flaticon.com/512/1827/1827409.png",
        vibrate: [200, 100, 200],
        tag: "session-alert",
        renotify: true
      });
    }).catch(err => {
      console.error("âŒ Notification via Service Worker fehlgeschlagen:", err);
    });
  } else {
    console.warn("âŒ Keine Notification mÃ¶glich â€“ Erlaubnis oder SW fehlen.");
  }
}

// âœ… Einheitlicher Notification-Aufruf fÃ¼r Sessionstarts
function showSessionStartNotification(sessionName, message) {
  const title = `ğŸ“£ ${sessionName}-Session gestartet!`;
  sendPushNotification(title, message);
}

// âœ… Diagnosetool zum Testen
function diagnoseNotifications() {
  const output = document.getElementById("notificationStatus");
  output.style.display = "block";

  let msg = "ğŸ” <strong>Benachrichtigungs-Check:</strong><br>";

  if (!("Notification" in window)) {
    msg += "âŒ Notifications werden vom Browser nicht unterstÃ¼tzt.<br>";
  } else {
    msg += `ğŸ“± Notification.permission: <strong>${Notification.permission}</strong><br>`;
    if (Notification.permission === "granted") {
      try {
        sendPushNotification("âœ… Test-Notification", "ğŸ¯ Die Notification funktioniert!");
        msg += "âœ… Test-Notification wurde ausgelÃ¶st.<br>";
      } catch (err) {
        msg += "âŒ Fehler beim Notification-Aufruf: " + err.message + "<br>";
      }
    } else if (Notification.permission === "denied") {
      msg += "ğŸš« Du hast Benachrichtigungen blockiert.<br>";
    } else if (Notification.permission === "default") {
      Notification.requestPermission().then((perm) => {
        msg += `ğŸ“© Neue Erlaubnis: ${perm}<br>`;
      });
    }
  }

  output.innerHTML = msg;
}

// âœ… Aktivierungs-Button
function enableNotifications() {
  Notification.requestPermission().then(permission => {
    const statusBox = document.getElementById("notificationStatus");
    statusBox.style.display = "block";

    if (permission === "granted") {
      sendPushNotification("âœ… Erlaubt", "Du bekommst ab jetzt Benachrichtigungen!");
      statusBox.innerHTML = "âœ… Benachrichtigungen erlaubt!";
    } else if (permission === "denied") {
      statusBox.innerHTML = "âŒ Benachrichtigungen blockiert. Aktiviere sie im Schloss-Symbol der Adresszeile.";
    } else {
      statusBox.innerHTML = "â„¹ï¸ Keine Entscheidung getroffen.";
    }
  });
}
</script>

<script>

<body>

<button onclick="enableNotifications()">ğŸ”“ Benachrichtigungen aktivieren</button>
<div id="notificationStatus" style="color:#0f0; font-weight:bold; margin-top:10px; display:none;"></div>

<button onclick="showSessionStartNotification('TEST Session', 'ğŸ”” Das ist eine Test-Benachrichtigung!')">
ğŸ“² Test Session Notification
</button>
<button onclick="diagnoseNotifications()">ğŸ” Benachrichtigung prÃ¼fen</button>
<div id="notificationStatus" style="color:#0f0; font-weight:bold; margin-top:10px; display:none;"></div>

</button>
<button onclick="sendPushNotification('ğŸ“² Push-Test', 'âœ… Funktioniert jetzt direkt auf dem Handy!')">
Test Push direkt
</button>
</button>
<script src="imageStorage.js"></script>

</body>
</html>

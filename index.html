<!DOCTYPE html>
<html lang="de">
<head>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#00aa44" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trade App Layout</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    .header {
      background: #1c1c1c;
      padding: 10px;
      text-align: center;
      font-size: 18px;
    }
    .session-bar {
      height: 10px;
      background: linear-gradient(to right, #00aaff, #ffaa00, #ff3300);
      margin-top: 5px;
    }
	
    .main {
      padding: 20px;
      padding-bottom: 120px; /* Platz f√ºr Positionsleiste */
      text-align: center;
    }
    .big-btn {
      padding: 20px 30px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 15px;
      border: none;
      background-color: #00aa44;
      color: white;
      margin: 20px auto;
      width: 80%;
      max-width: 300px;
    }
    .tab-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .tab-buttons button {
      background: #333;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      margin: 5px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .tab-buttons .active {
      background: #0077cc;
    }
    .stats-box {
      background: #222;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    #resetBtn {
      background: #cc3333;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      font-weight: bold;
      margin: 20px auto 30px auto;
      cursor: pointer;
      display: block;
      user-select: none;
      position: relative; /* kein fixed */
      z-index: auto;
    }
    .position-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #1c1c1c;
      padding: 10px;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      box-sizing: border-box;
      z-index: 10000; /* √ºber anderen Elementen */
	  touch-action: pan-y; /* Erlaubt vertikales Scrollen, verhindert horizontale Interferenzen */
    }
    .trade-box {
      flex: 0 0 auto;
      box-sizing: border-box;
      width: 85%;
      max-width: 280px;
      background: #333;
      padding: 10px;
      border-radius: 10px;
      min-width: 180px;
      color: white;
      user-select: none;
      z-index: 10001; /* √ºber reset Button */
	   touch-action: none; /* Damit alle Touch-Events an JS gehen */
      position: relative;
    }
    .trade-box.Long {
      background-color: #228B22; /* gr√ºn */
    }
    .trade-box.Short {
      background-color: #B22222; /* rot */
    }
    .result-value {
      margin-top: 5px;
      font-weight: bold;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      display: none;
      z-index: 1000;
      width: 90%;
      max-width: 300px;
      color: white;
    }
    label {
      cursor: pointer;
      user-select: none;
      margin-right: 15px;
      display: inline-block;
    }
    #pairMultiSelect {
      max-height: 150px;
      overflow-y: auto;
      background: #222;
      padding: 5px;
      border-radius: 6px;
      color: white;
      margin-bottom: 10px;
      text-align: left;
    }
    select, input {
      padding: 8px;
      margin-top: 10px;
      width: 100%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    .popup button {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
    }
    .ticker {
      width: 100%;
      background: #222;
      color: #00ff99;
      padding: 10px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      user-select: none;
    }
    .session-info {
      margin-top: 5px;
      font-size: 14px;
      color: #aaf0aa;
      text-align: center;
      font-style: italic;
      user-select: none;
    }
	
.session-details-box {
  display: none;
  background: #1a1a1a;
  padding: 15px;
  margin: 10px 20px;
  border-radius: 10px;
  font-size: 14px;
  color: #eee;
  text-align: left;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
}


  .session-details-box {
    font-size: 13px;
    margin: 10px;
    padding: 12px;
    line-height: 1.4;
  }

  .session-header, #sessionText {
    font-size: 16px;
    padding: 12px;
  }
  
  #sessionText {
  user-select: none;
  cursor: pointer;
}
    .progress-container {
      position: relative;
      background: #111;
      height: 24px;
      width: 100%;
      border-top: 1px solid #333;
      border-bottom: 1px solid #333;
      overflow: hidden;
      border-radius: 6px;
      margin-top: 5px;
    }
    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%; /* wird per JS gesetzt */
      background: linear-gradient(to right, #00aaff, #ffaa00, #ff3300);
      transition: width 1s linear;
      background-size: 100% 100%;
      background-repeat: no-repeat;
      z-index: 2;
    }
	
	.session-details-box ul {
  padding-left: 20px;
  margin-top: 8px;
  margin-bottom: 8px;
  list-style-type: disc;
}

.session-details-box li {
  margin-bottom: 4px;
}
	
	
  </style>
</head>
<body>

<div style="margin-top: 10px;">
  <input type="email" id="myfxEmail" placeholder="Myfxbook Email" />
  <input type="password" id="myfxPassword" placeholder="Myfxbook Passwort" />
  <button onclick="doMyfxLogin()">üîê Myfxbook Login</button>
</div>

<button onclick="syncMyfxbook()">üì• Myfxbook Trades importieren</button>

<div class="ticker" id="sessionText">Session-Zeit: 00:00</div>
<div class="session-info" id="sessionInfo">Tipps und Infos zur Session erscheinen hier...</div>
<div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
</div>
<div class="session-details-box" id="sessionDetailsBox"></div>
<div class="alert-below-header" id="alertBox"></div>

<div class="main">
  <button class="big-btn" onclick="showPopup()">+ Trade starten</button>

  <div class="tab-buttons">
    <button class="btn active" onclick="switchTab('tag')">Tag</button>
    <button class="btn" onclick="switchTab('woche')">Woche</button>
    <button class="btn" onclick="switchTab('monat')">Monat</button>
	<button class="btn" onclick="switchTab('halbjahr')">Halbjahr</button>
  <button class="btn" onclick="switchTab('jahr')">Jahr</button>
  </div>
  
  <div id="sessionProgressDisplay" style="font-size: 13px; color: #aaa; margin-top: 5px;"></div>

  <div class="stats-box" id="tagBox">
    <h3>üìÖ Tagesauswertung</h3>
    <p>Gewinne: 0 | Verluste: 0</p>
    <p>Gesamt PnL: 0 ‚Ç¨</p>
    <p>Profitfaktor: ‚Äì</p>
    <p>Durchschnitt Gewinn/Verlust: ‚Äì</p>
  </div>

  <div class="stats-box" id="wocheBox" style="display:none">
    <h3>üìà Wochenauswertung</h3>
    <p>Gewinne: 0 | Verluste: 0</p>
    <p>Gesamt PnL: 0 ‚Ç¨</p>
    <p>Profitfaktor: ‚Äì</p>
    <p>Durchschnitt Gewinn/Verlust: ‚Äì</p>
  </div>

  <div class="stats-box" id="monatBox" style="display:none">
    <h3>üìä Monatsauswertung</h3>
    <p>Gewinne: 0 | Verluste: 0</p>
    <p>Gesamt PnL: 0 ‚Ç¨</p>
    <p>Profitfaktor: ‚Äì</p>
    <p>Durchschnitt Gewinn/Verlust: ‚Äì</p>
  </div>
  
  <div class="stats-box" id="halbjahrBox" style="display:none">
  <h3>üìÖ Halbjahresauswertung</h3>
  <p>Gewinne: 0 | Verluste: 0</p>
  <p>Gesamt PnL: 0 ‚Ç¨</p>
  <p>Profitfaktor: ‚Äì</p>
  <p>Durchschnitt Gewinn/Verlust: ‚Äì</p>
</div>

<div class="stats-box" id="jahrBox" style="display:none">
  <h3>üìÜ Jahresauswertung</h3>
  <p>Gewinne: 0 | Verluste: 0</p>
  <p>Gesamt PnL: 0 ‚Ç¨</p>
  <p>Profitfaktor: ‚Äì</p>
  <p>Durchschnitt Gewinn/Verlust: ‚Äì</p>
</div>

<div id="resetPopup" class="popup" style="display: none;">
  <h3>Was m√∂chtest du zur√ºcksetzen?</h3>
  <button id="resetDay">üìÖ Tag zur√ºcksetzen</button>
  <button id="resetWeek">üìà Woche zur√ºcksetzen</button>
  <button id="resetMonth">üìä Monat zur√ºcksetzen</button>
  <button id="resetAllBtn" style="background: crimson;">Alles l√∂schen</button>
  <button id="cancelReset" style="background:#555;">Abbrechen</button>
</div>
 <button id="resetBtn">Alles zur√ºcksetzen</button>
  

</div>

<div class="popup" id="tradePopup">
  <h3>Trade eingeben</h3>

  <label>Paare ausw√§hlen (mehrere m√∂glich):</label><br>
  <div id="pairMultiSelect"></div>


  <label for="directionSelect">Postion w√§hlen:</label>
  <select id="directionSelect" style="width: 100%; margin-top: 5px;">
    <option value="">Bitte w√§hlen</option>
    <option value="Long">Long</option>
    <option value="Short">Short</option>
  </select>

  <button onclick="addTrades()">Trades speichern</button>
   <button onclick="hidePopups()" style="margin-top:10px; background:#555;">Abbrechen</button>
</div>

<div class="popup" id="resultPopup">
  <h3>Ergebnis</h3>
  <input type="text" inputmode="decimal" id="pnlInput" placeholder="z.‚ÄØB. 120.50" value="00,00" />
  <button onclick="saveResult()">Speichern</button>
</div>

<div class="position-bar" id="positionBar"></div>

<script>
  const pairs = [
  "AUD/CAD",
  "AUD/JPY",
  "AUD/USD",
  "CHF/JPY",
  "EUR/AUD",
  "EUR/CAD",
  "EUR/GBP",
  "EUR/JPY",
  "EUR/USD",
  "GBP/AUD",
  "GBP/JPY",
  "GBP/USD",
  "NZD/JPY",
  "NZD/USD",
  "USD/CAD",
  "USD/CHF",
  "USD/JPY",
  "XAG/USD",
  "XAU/USD"
];

function initMultiPairSelect() {
  const container = document.getElementById("pairMultiSelect");
  container.innerHTML = "";

  pairs.forEach(pair => {
    const label = document.createElement("label");
    label.style.marginRight = "15px";
    label.style.cursor = "pointer";
    label.style.userSelect = "none";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = pair;
    checkbox.checked = false;

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(" " + pair));
    container.appendChild(label);
  });
}

function addTrades() {
  const container = document.getElementById("pairMultiSelect");
  const checkboxes = container.querySelectorAll("input[type=checkbox]:checked");
  const direction = document.getElementById("directionSelect").value;

  if (!direction) {
    alert("Bitte w√§hle eine Richtung!");
    return;
  }
  if (checkboxes.length === 0) {
    alert("Bitte w√§hle mindestens ein Paar aus!");
    return;
  }

  checkboxes.forEach(box => {
    const pair = box.value;
    const now = new Date();
    const tradeObj = {
      id: Date.now() + Math.random(),
      pair: pair,
      direction: direction,
      date: now,
      pnl: null,
      resultType: null
    };
    tradesData.push(tradeObj);
    renderTradeBox(tradeObj);
  });

  saveTrades();
  hidePopups();
}

function resetAll() {
  if (!confirm("Willst du wirklich ALLE Trades und Statistiken l√∂schen?")) return;

  tradesData.length = 0;
  localStorage.removeItem("tradesData");
  document.getElementById("positionBar").innerHTML = "";
  updateStats();
}

function isSameDay(date1, date2) {
  return (
    date1.getDate() === date2.getDate() &&
    date1.getMonth() === date2.getMonth() &&
    date1.getFullYear() === date2.getFullYear()
  );
}

function isSameWeek(date1, date2) {
  const startOfWeek = new Date(date2);
  startOfWeek.setDate(date2.getDate() - date2.getDay());
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);
  return date1 >= startOfWeek && date1 <= endOfWeek;
}

function isSameMonth(date1, date2) {
  return date1.getMonth() === date2.getMonth() && date1.getFullYear() === date2.getFullYear();
}

function isSameHalfYear(date1, date2) {
  const half1 = date2.getMonth() < 6; // Jan-Jun ist erstes Halbjahr
  const half2 = date1.getMonth() < 6;
  return half1 === half2 && date1.getFullYear() === date2.getFullYear();
}

function isSameYear(date1, date2) {
  return date1.getFullYear() === date2.getFullYear();
}

const tradesData = [];
let activeBox = null;
let resultType = "win";

function loadTrades() {
  const saved = localStorage.getItem("tradesData");
  if (saved) {
    const arr = JSON.parse(saved);
    tradesData.length = 0;
    document.getElementById("positionBar").innerHTML = "";
    arr.forEach((trade) => {
      trade.date = new Date(trade.date);
      tradesData.push(trade);
      if (trade.pnl === null) {
        renderTradeBox(trade);
      }
    });
  }
  updateStats();
}

function saveTrades() {
  localStorage.setItem("tradesData", JSON.stringify(tradesData));
}

function renderTradeBox(tradeObj) {
  const box = document.createElement("div");
  box.className = "trade-box " + tradeObj.direction;
  box.dataset.id = tradeObj.id;

  // Touchstart Listener
  let touchStartY = 0;
  let isSwiping = false;
  box.addEventListener("touchstart", (e) => {
    touchStartY = e.touches[0].clientY;
    isSwiping = false;
  }, { passive: true });

  // Close (X) Button zum Entfernen oben rechts
  const closeBtn = document.createElement("button");
  closeBtn.type = "button"; // wichtig f√ºr mobile Browser
  closeBtn.textContent = "‚úñ"; // kleines X
  closeBtn.style.position = "absolute";
  closeBtn.style.top = "8px";
  closeBtn.style.right = "8px";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "white";
  closeBtn.style.fontSize = "20px";
  closeBtn.style.cursor = "pointer";
  closeBtn.style.zIndex = "10"; // sicherstellen, dass oben
  closeBtn.title = "Trade entfernen";
  closeBtn.addEventListener("click", (e) => {
    e.stopPropagation(); // Verhindert, dass andere Events feuern
    removeTradeById(tradeObj.id);
  });
  box.style.position = "relative"; // damit closeBtn richtig positioniert ist
  box.appendChild(closeBtn);

  let resultText = "";
  if (tradeObj.pnl !== null) {
    resultText = `<div class="result-value">PnL: ${tradeObj.pnl.toFixed(2)} ‚Ç¨</div>`;
  } else {
    resultText = `
      <button onclick="markResult(this, 'win')">‚úÖ Erfolg</button>
      <button onclick="markResult(this, 'loss')">‚ùå Misserfolg</button>
      <div class="result-value"></div>
    `;
  }

  const contentDiv = document.createElement("div");
  contentDiv.innerHTML = `<strong>${tradeObj.pair}</strong><br>${tradeObj.direction}<br>${resultText}`;
  box.appendChild(contentDiv);

  // Swipe-up f√ºr Handy (Touch-Event)
  box.addEventListener("touchmove", e => {
    const touchCurrentY = e.touches[0].clientY;
    const diffY = touchStartY - touchCurrentY;

    if (diffY > 15) { // kleiner Swipe-Up Threshold
      if (!isSwiping) {
        isSwiping = true;
        e.preventDefault(); // verhindert Scrollen
        removeTradeById(tradeObj.id);
      }
    }
  }, { passive: false });

  box.addEventListener("touchend", () => {
    touchStartY = 0;
    isSwiping = false;
  });

  document.getElementById("positionBar").appendChild(box);
}

function removeTradeById(id) {
  const index = tradesData.findIndex(t => t.id === id);
  if (index !== -1) {
    tradesData.splice(index, 1);
    saveTrades();
    loadTrades(); // neu rendern
  }
}

function markResult(btn, type) {
  activeBox = btn.closest(".trade-box");
  resultType = type;
  document.getElementById("pnlInput").value = "";
  document.getElementById("resultPopup").style.display = "block";
}

function saveResult() {
  let pnlRaw = document.getElementById("pnlInput").value;
  if (pnlRaw === "") return;

  // Tausenderpunkte entfernen und Komma durch Punkt ersetzen
  pnlRaw = pnlRaw.replace(/\./g, '').replace(',', '.');

  let pnl = parseFloat(pnlRaw);
  if (isNaN(pnl)) return;

  pnl = Math.abs(pnl);
  pnl = resultType === "loss" ? -pnl : pnl;

  const resultDiv = activeBox.querySelector(".result-value");
  resultDiv.innerText = `PnL: ${pnl.toFixed(2)} ‚Ç¨`;

  const tradeId = activeBox.dataset.id;
  const trade = tradesData.find((t) => t.id == tradeId);
  if (trade) {
    trade.pnl = pnl;
    trade.resultType = resultType;
  }

  activeBox.remove();

  saveTrades();

  hidePopups();
  updateStats();
}




function updateStats() {
  const now = new Date();

  function calcStats(filterFn) {
    const filtered = tradesData.filter((t) => t.pnl !== null && filterFn(t.date));
    const wins = filtered.filter((t) => t.pnl > 0);
    const losses = filtered.filter((t) => t.pnl < 0);
    const totalPnl = filtered.reduce((sum, t) => sum + t.pnl, 0);
    const totalAbsPnl = filtered.reduce((sum, t) => sum + Math.abs(t.pnl), 0);
	

    const profitFactor =
      losses.length === 0
        ? "‚Äì"
        : (wins.reduce((s, t) => s + t.pnl, 0) / Math.abs(losses.reduce((s, t) => s + t.pnl, 0))).toFixed(2);

    const avg = filtered.length === 0 ? "‚Äì" : (totalPnl / filtered.length).toFixed(2);
    const profitPercent = totalAbsPnl === 0 ? null : ((wins.reduce((sum, t) => sum + t.pnl, 0) / totalAbsPnl) * 100);

    return {
      trades: filtered,
      wins: wins.length,
      losses: losses.length,
      totalPnl,
      avg,
      totalTrades: wins.length + losses.length,
      profitPercent
    };
  }

  function colorText(value, isPnl = false) {
  if (isPnl) {
    return value >= 0
      ? `<span style="color: #0f0;">${value.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨</span>`
      : `<span style="color: #f44;">${value.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨</span>`;
  } else {
    return `<span style="color: ${value > 0 ? "#0f0" : "#f44"}">${value}</span>`;
  }
}

  function colorProfitPercent(p) {
    if (p === null) return "‚Äì";
    if (p < 35) return `<span style="color:#f44">${p.toFixed(1)}%</span>`;
    if (p < 50) return `<span style="color:#ffcc00">${p.toFixed(1)}%</span>`;
    if (p < 75) return `<span style="color:#9acd32">${p.toFixed(1)}%</span>`;
    return `<span style="color:#008000">${p.toFixed(1)}%</span>`;
  }

  function countLongShortWins(trades) {
    const longs = trades.filter(t => t.direction === "Long" && t.pnl > 0).length;
    const shorts = trades.filter(t => t.direction === "Short" && t.pnl > 0).length;
    return { longs, shorts };
  }

  const isToday = (date) => isSameDay(date, now);
  const isThisWeek = (date) => isSameWeek(date, now);
  const isThisMonth = (date) => isSameMonth(date, now);
  const isThisHalfYear = (date) => isSameHalfYear(date, now);
  const isThisYear = (date) => isSameYear(date, now);

  const dayStats = calcStats(isToday);
  const weekStats = calcStats(isThisWeek);
  const monthStats = calcStats(isThisMonth);
  const halfYearStats = calcStats(isThisHalfYear);
  const yearStats = calcStats(isThisYear);

  const dayLongShort = countLongShortWins(dayStats.trades);
  const weekLongShort = countLongShortWins(weekStats.trades);
  const monthLongShort = countLongShortWins(monthStats.trades);
  const halfYearLongShort = countLongShortWins(halfYearStats.trades);
  const yearLongShort = countLongShortWins(yearStats.trades);

  const tagBox = document.getElementById("tagBox");
  tagBox.querySelector("p:nth-child(2)").innerHTML =
  `Gewinne: ${colorText(dayStats.wins)} | Verluste: ${colorText(dayStats.losses)}<br>` +
  `Long-Wins: ${dayLongShort.longs} | Short-Wins: ${dayLongShort.shorts}<br>` +
  `St√§rke: ${colorSidePercent(dayLongShort.longs, dayLongShort.shorts)}`;
  tagBox.querySelector("p:nth-child(3)").innerHTML = `Gesamt PnL: ${colorText(dayStats.totalPnl, true)}`;
  tagBox.querySelector("p:nth-child(4)").innerHTML = `Anzahl Trades: ${dayStats.totalTrades}`;
  tagBox.querySelector("p:nth-child(5)").innerHTML = `Profitabel: ${colorProfitPercent(dayStats.profitPercent)}`;

  const wocheBox = document.getElementById("wocheBox");
wocheBox.querySelector("p:nth-child(2)").innerHTML =
  `Gewinne: ${colorText(weekStats.wins)} | Verluste: ${colorText(weekStats.losses)}<br>` +
  `Long-Wins: ${weekLongShort.longs} | Short-Wins: ${weekLongShort.shorts}<br>` +
  `St√§rke: ${colorSidePercent(weekLongShort.longs, weekLongShort.shorts)}`;
wocheBox.querySelector("p:nth-child(3)").innerHTML = `Gesamt PnL: ${colorText(weekStats.totalPnl, true)}`;
wocheBox.querySelector("p:nth-child(4)").innerHTML = `Anzahl Trades: ${weekStats.totalTrades}`;
wocheBox.querySelector("p:nth-child(5)").innerHTML = `Profitabel: ${colorProfitPercent(weekStats.profitPercent)}`;


  const monatBox = document.getElementById("monatBox");
monatBox.querySelector("p:nth-child(2)").innerHTML =
  `Gewinne: ${colorText(monthStats.wins)} | Verluste: ${colorText(monthStats.losses)}<br>` +
  `Long-Wins: ${monthLongShort.longs} | Short-Wins: ${monthLongShort.shorts}<br>` +
  `St√§rke: ${colorSidePercent(monthLongShort.longs, monthLongShort.shorts)}`;
monatBox.querySelector("p:nth-child(3)").innerHTML = `Gesamt PnL: ${colorText(monthStats.totalPnl, true)}`;
monatBox.querySelector("p:nth-child(4)").innerHTML = `Anzahl Trades: ${monthStats.totalTrades}`;
monatBox.querySelector("p:nth-child(5)").innerHTML = `Profitabel: ${colorProfitPercent(monthStats.profitPercent)}`;

 const halbjahrBox = document.getElementById("halbjahrBox");
halbjahrBox.querySelector("p:nth-child(2)").innerHTML =
  `Gewinne: ${colorText(halfYearStats.wins)} | Verluste: ${colorText(halfYearStats.losses)}<br>` +
  `Long-Wins: ${halfYearLongShort.longs} | Short-Wins: ${halfYearLongShort.shorts}<br>` +
  `St√§rke: ${colorSidePercent(halfYearLongShort.longs, halfYearLongShort.shorts)}`;
halbjahrBox.querySelector("p:nth-child(3)").innerHTML = `Gesamt PnL: ${colorText(halfYearStats.totalPnl, true)}`;
halbjahrBox.querySelector("p:nth-child(4)").innerHTML = `Anzahl Trades: ${halfYearStats.totalTrades}`;
halbjahrBox.querySelector("p:nth-child(5)").innerHTML = `Profitabel: ${colorProfitPercent(halfYearStats.profitPercent)}`;

 const jahrBox = document.getElementById("jahrBox");
jahrBox.querySelector("p:nth-child(2)").innerHTML =
  `Gewinne: ${colorText(yearStats.wins)} | Verluste: ${colorText(yearStats.losses)}<br>` +
  `Long-Wins: ${yearLongShort.longs} | Short-Wins: ${yearLongShort.shorts}<br>` +
  `St√§rke: ${colorSidePercent(yearLongShort.longs, yearLongShort.shorts)}`;
jahrBox.querySelector("p:nth-child(3)").innerHTML = `Gesamt PnL: ${colorText(yearStats.totalPnl, true)}`;
jahrBox.querySelector("p:nth-child(4)").innerHTML = `Anzahl Trades: ${yearStats.totalTrades}`;
jahrBox.querySelector("p:nth-child(5)").innerHTML = `Profitabel: ${colorProfitPercent(yearStats.profitPercent)}`;

}

function switchTab(tab) {
  document.querySelectorAll(".tab-buttons button").forEach(btn => btn.classList.remove("active"));
  document.querySelectorAll(".stats-box").forEach(box => (box.style.display = "none"));
  document.getElementById(tab + "Box").style.display = "block";
  document.querySelectorAll(".tab-buttons button").forEach((btn) => {
    if (btn.textContent.toLowerCase() === tab) btn.classList.add("active");
  });
}

function colorSidePercent(longWins, shortWins) {
  const total = longWins + shortWins;
  if (total === 0) return "‚Äì";

  const longPercent = (longWins / total) * 100;
  const shortPercent = (shortWins / total) * 100;

  const longColor = longPercent > shortPercent ? "#0f0" : "#f44";
  const shortColor = shortPercent > longPercent ? "#0f0" : "#f44";

  return `
    <span style="color:${longColor}">Long: ${longPercent.toFixed(1)}%</span> | 
    <span style="color:${shortColor}">Short: ${shortPercent.toFixed(1)}%</span>
  `;
}


function showPopup() {
  document.getElementById("tradePopup").style.display = "block";
}

function hidePopups() {
  document.getElementById("tradePopup").style.display = "none";
  document.getElementById("resultPopup").style.display = "none";
}

function resetDay() {
  const today = new Date();
  const remaining = tradesData.filter(t => !isSameDay(t.date, today));
  tradesData.length = 0;
  tradesData.push(...remaining);
  saveTrades();
  loadTrades();
}

function resetWeek() {
  const today = new Date();
  const remaining = tradesData.filter(t => !isSameWeek(t.date, today));
  tradesData.length = 0;
  tradesData.push(...remaining);
  saveTrades();
  loadTrades();
}

function resetMonth() {
  const today = new Date();
  const remaining = tradesData.filter(t => !isSameMonth(t.date, today));
  tradesData.length = 0;
  tradesData.push(...remaining);
  saveTrades();
  loadTrades();
}

window.addEventListener("load", () => {
  initMultiPairSelect();
  loadTrades();

  const resetBtn = document.getElementById("resetBtn");
  const resetDayBtn = document.getElementById("resetDay");
  const resetWeekBtn = document.getElementById("resetWeek");
  const resetMonthBtn = document.getElementById("resetMonth");
  const resetAllBtn = document.getElementById("resetAllBtn");
  const cancelResetBtn = document.getElementById("cancelReset");

  if (resetBtn) {
    resetBtn.addEventListener("click", () => {
      document.getElementById("resetPopup").style.display = "block";
    });
  }

  if (resetDayBtn) {
    resetDayBtn.addEventListener("click", () => {
      resetDay();
      document.getElementById("resetPopup").style.display = "none";
    });
  }

  if (resetWeekBtn) {
    resetWeekBtn.addEventListener("click", () => {
      resetWeek();
      document.getElementById("resetPopup").style.display = "none";
    });
  }

  if (resetMonthBtn) {
    resetMonthBtn.addEventListener("click", () => {
      resetMonth();
      document.getElementById("resetPopup").style.display = "none";
    });
  }

  if (resetAllBtn) {
    resetAllBtn.addEventListener("click", () => {
      resetAll();
      document.getElementById("resetPopup").style.display = "none";
    });
  }

  if (cancelResetBtn) {
    cancelResetBtn.addEventListener("click", () => {
      document.getElementById("resetPopup").style.display = "none";
    });
  }
});
  window.addEventListener('load', () => {
    const pnlInput = document.getElementById("pnlInput");

    function formatNumberDE(value) {
      const number = Number(value.toString().replace(/\./g, '').replace(',', '.'));
      if (isNaN(number)) return '00,00';

      return number.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    pnlInput.addEventListener('focus', () => {
      if (pnlInput.value === '00,00') {
        pnlInput.value = '';
      }
    });

    pnlInput.addEventListener('blur', () => {
      pnlInput.value = formatNumberDE(pnlInput.value);
    });
  });


  </script>
  
<script>
const sessionText = document.getElementById("sessionText");
const sessionProgressEl = document.getElementById("sessionProgressDisplay");
const sessionInfoEl = document.getElementById("sessionInfo");
const sessionDetailsBox = document.getElementById("sessionDetailsBox");
const alertBox = document.getElementById("alertBox");
const progressBar = document.getElementById("progressBar");
const progressContainer = document.querySelector(".progress-container");

sessionText.addEventListener("click", () => {
  sessionDetailsBox.style.display = sessionDetailsBox.style.display === "block" ? "none" : "block";
});

function formatHM(mins) {
  const h = Math.floor(mins / 60) % 24;
  const m = mins % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

const sessionColors = {
  Sydney: "#3388ff",
  Tokyo: "#00aaff",
  London: "#ffd700",
  "New York": "#ff4500",
  "London Killzone": "#ccff00",
  "New York Killzone": "#ff8800",
  Deadzone: "#333",
};

const sessions = [
  { name: "Sydney", start: 1380, end: 480, info: "Australische Session, oft ruhiger." },
  { name: "Tokyo", start: 60, end: 600, info: "Asiatischer Handel ‚Äì Fokus auf JPY & AUD." },
  { name: "London Killzone", start: 480, end: 540, info: "Hohe Volatilit√§t ‚Äì viele Breakouts." },
  { name: "London", start: 540, end: 1020, info: "Europ√§ische Session mit viel Volumen." },
  { name: "New York Killzone", start: 840, end: 900, info: "Wichtige US-News & schnelle Bewegungen." },
  { name: "New York", start: 870, end: 1380, info: "Amerikanische Session ‚Äì hohe Volatilit√§t." },
  { name: "Deadzone", start: 720, end: 840, info: "Mittagliche Ruhephase ‚Äì oft Konsolidierung." }
];


let lastAlertSession = null;

function getMinutesNow() {
  const now = new Date();
  return now.getHours() * 60 + now.getMinutes();
}

function getCurrentSessions(minNow) {
  return sessions.filter((s) => {
    const start = s.start;
    const end = s.end;
    if (start > end) {
      return minNow >= start || minNow < end;
    } else {
      return minNow >= start && minNow < end;
    }
  });
}

function updateGradientBar(colors) {
  if (colors.length === 0) {
    progressBar.style.background = "#444";
    progressBar.style.backgroundImage = "";
    return;
  }
  const svg = `
    <svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%'>
      <defs>
        <linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='0%'>
          ${colors.map((c, i) => `<stop offset='${(i / (colors.length - 1)) * 100}%' stop-color='${c}'/>`).join("")}
        </linearGradient>
      </defs>
      <rect x='0' y='0' width='100%' height='100%' fill='url(#g)'/>
    </svg>`;
  const base64 = btoa(svg);
  progressBar.style.backgroundImage = `url("data:image/svg+xml;base64,${base64}")`;
}

function hexToRgba(hex, alpha) {
  hex = hex.replace("#", "");
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function getMinutesToNextSession(minNow) {
  const futureStarts = sessions.map((s) => s.start).filter((start) => start > minNow);
  if (futureStarts.length === 0) return sessions[0].start + 1440 - minNow;
  return Math.min(...futureStarts) - minNow;
}

const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

function requestNotificationPermission() {
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }
}

function showNotification(title, message) {
  if ("Notification" in window && Notification.permission === "granted") {
    const options = {
      body: message,
      icon: 'https://cdn-icons-png.flaticon.com/512/1827/1827409.png',
      vibrate: [200, 100, 200],
      tag: "session-alert"
    };
    const notification = new Notification(title, options);
    notification.onclick = () => {
      window.focus();
      notification.close();
    };
  }
}

function showAlert(msg) {
  const el = document.createElement("div");
  el.className = "alert-message";
  el.textContent = msg;
  alertBox.innerHTML = "";
  alertBox.appendChild(el);
  setTimeout(() => (alertBox.innerHTML = ""), 5000);
  alertSound.play();
  showNotification("Trade App Alarm", msg);
}

function showSessionProgress(activeSessions, currentMinutes) {
  if (activeSessions.length === 0) {
    sessionProgressEl.innerHTML = "‚è≥ Keine aktive Session ‚Äì kein Countdown";
    return;
  }
  const current = activeSessions[0];
  let start = current.start;
  let end = current.end;
  if (start > end) end += 1440;
  let nowMins = currentMinutes;
  if (nowMins < start) nowMins += 1440;
  const duration = end - start;
  const progressMins = nowMins - start;
  const percent = (progressMins / duration) * 100;
  const timeLeft = end - nowMins;
  sessionProgressEl.innerHTML = `‚è±Ô∏è Noch <strong>${formatHM(timeLeft)}</strong> ‚Äì <strong>${percent.toFixed(0)}%</strong> vorbei`;
}

function updateRealTimeBar() {
  const now = new Date();
  const weekday = now.getDay(); // Sonntag = 0, Samstag = 6
  const hours = String(now.getHours()).padStart(2, "0");
  const mins = String(now.getMinutes()).padStart(2, "0");

  // üëâ Wochenende
  if (weekday === 0 || weekday === 6) {
    sessionText.textContent = `üïí Aktuelle Uhrzeit: ${hours}:${mins} ‚Äì Wochenende`;
    progressBar.style.width = "0%";
    progressBar.style.background = "#333";
    progressBar.style.backgroundImage = "";
    progressContainer.style.boxShadow = "0 0 12px 6px rgba(0,0,0,0)";
    sessionInfoEl.textContent = "üì¥ Wochenende ‚Äì Markt ist geschlossen.";
    sessionProgressEl.innerHTML = "‚õî Kein Handel ‚Äì Wochenende";
    sessionDetailsBox.innerHTML = "Keine Session-Daten am Wochenende.";
    return;
  }

  // ‚è¨ Ab hier normaler Werktags-Ablauf
  const minutes = now.getHours() * 60 + now.getMinutes();
  const percent = (minutes / 1439) * 100;

  sessionText.textContent = `üïí Aktuelle Uhrzeit: ${hours}:${mins}`;

  progressBar.style.width = `${percent}%`;

  const activeSessions = getCurrentSessions(minutes);
  const names = activeSessions.map(s => s.name);
  const colors = names.map(n => sessionColors[n] || "#666");

  updateGradientBar(colors);
  showSessionProgress(activeSessions, minutes);

  progressContainer.style.boxShadow = colors.length > 0
    ? `0 0 12px 6px ${hexToRgba(colors[0], 0.6)}`
    : "0 0 12px 6px rgba(0,0,0,0)";

  const name = activeSessions.length > 0 ? activeSessions[0].name : "";
  let infoText = "Keine aktiven Sessions ‚Äì Markt wahrscheinlich ruhig.";

  if (name === "Tokyo") {
    infoText = minutes < 180 ? "üåè Tokyo er√∂ffnet ‚Äì erste Bewegungen durch asiatische H√§ndler." :
                minutes < 360 ? "üáØüáµ Asiatische Volatilit√§t aktiv ‚Äì m√∂gliche Bewegungen bei JPY." :
                "üõë Tokyo flacht ab ‚Äì Fokus wechselt langsam nach Europa.";
  } else if (name === "London Killzone") {
    infoText = "‚ö†Ô∏è London Killzone ‚Äì hohe Volatilit√§t & starke Bewegungen m√∂glich.";
  } else if (name === "London") {
    infoText = minutes < 720 ? "üí∑ London Session ‚Äì Markt in Bewegung, europ√§ische Daten entscheidend." :
                minutes < 840 ? "üò¥ Mittagliche Deadzone ‚Äì Markt konsolidiert h√§ufig, Vorsicht bei Entries." :
                "üìà London-Teilnehmer bleiben aktiv ‚Äì Vorbereitung auf NY.";
  } else if (name === "New York Killzone") {
    infoText = "üî• New York Killzone ‚Äì starke Reaktionen auf US-News & Breakouts m√∂glich.";
  } else if (name === "New York") {
    infoText = minutes < 1080 ? "üá∫üá∏ New York Session ‚Äì starker US-Einfluss, Trendfortsetzungen m√∂glich." :
                minutes < 1200 ? "üìâ New York flacht ab ‚Äì Markt beruhigt sich langsam." :
                "üåÉ New York Session endet ‚Äì geringe Bewegung, Vorsicht bei Entries.";
  } else if (minutes >= 720 && minutes < 840) {
    infoText = "üò¥ Mittagliche Deadzone ‚Äì Markt konsolidiert h√§ufig, Vorsicht bei Entries.";
  } else if (minutes >= 1380 || minutes < 60) {
    infoText = "üåô Nacht-Deadzone ‚Äì Markt ist extrem ruhig, keine relevanten Bewegungen.";
  }

  sessionInfoEl.textContent = infoText;

  if (activeSessions.length > 0) {
    const s = activeSessions[0];
    let weekDaysHtml = "";
    if (s.weekDaysInfo) {
      weekDaysHtml = "<br><strong>üìÖ Wichtige Tage:</strong><ul style='margin-left:18px;'>";
      s.weekDaysInfo.forEach(({ day, text }) => {
        weekDaysHtml += `<li><strong>${day}:</strong> ${text}</li>`;
      });
      weekDaysHtml += "</ul>";
    }
    sessionDetailsBox.innerHTML = `
      <strong>üü° ${s.name} Session</strong><br>
      üìÖ Start: ${formatHM(s.start)} Uhr<br>
      üïì Ende: ${formatHM(s.end)} Uhr<br>
      ‚ÑπÔ∏è ${s.info}
      ${weekDaysHtml}
    `;
  } else {
    sessionDetailsBox.innerHTML = "Keine aktive Session ‚Äì Markt ist ruhig.";
  }

  const minutesToNext = getMinutesToNextSession(minutes);
  if (minutesToNext <= 5 && minutesToNext > 0) {
    if (lastAlertSession !== sessionText.textContent) {
      showAlert(`‚ö†Ô∏è Session-Wechsel in 5 Minuten!`);
      lastAlertSession = sessionText.textContent;
    }
  } else {
    lastAlertSession = null;
  }
}

window.addEventListener("load", () => {
  requestNotificationPermission();
  updateRealTimeBar();
  setInterval(updateRealTimeBar, 60000);
});
</script>

<script>
  // Service Worker Registrierung
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("sw.js")
        .then(reg => {
          console.log("Service Worker registriert:", reg);
        })
        .catch(err => {
          console.error("Service Worker Registrierung fehlgeschlagen:", err);
        });
    });
  }
</script>

<script>
  let myfxSession = null;

  async function loginToMyfxbook(email, password) {
    try {
      const url = `https://www.myfxbook.com/api/login.json?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
      const res = await fetch(url);
      const data = await res.json();

      if (data.error || !data.session) {
        alert("‚ùå Login fehlgeschlagen: " + (data.message || "Unbekannter Fehler"));
        return;
      }

      myfxSession = data.session;
      localStorage.setItem("myfxSession", myfxSession);
      alert("‚úÖ Login erfolgreich");
    } catch (e) {
      alert("‚ö†Ô∏è Fehler beim Login (Netzwerk oder CORS)");
    }
  }

  function doMyfxLogin() {
    const email = document.getElementById("myfxEmail").value;
    const pw = document.getElementById("myfxPassword").value;
    if (!email || !pw) return alert("Bitte E-Mail & Passwort eingeben!");

    localStorage.setItem("myfxEmail", email);
    localStorage.setItem("myfxPassword", pw);
    loginToMyfxbook(email, pw);
  }

  async function getMyfxAccounts() {
    const res = await fetch(`https://www.myfxbook.com/api/get-my-accounts.json?session=${myfxSession}`);
    const data = await res.json();
    return data.accounts[0].id;
  }

  async function getMyfxHistory(accountId) {
    const res = await fetch(`https://www.myfxbook.com/api/get-history.json?session=${myfxSession}&id=${accountId}`);
    const data = await res.json();
    return data.history;
  }

  async function syncMyfxbook() {
    if (!myfxSession) {
      alert("‚ö†Ô∏è Bitte zuerst einloggen!");
      return;
    }

    const accountId = await getMyfxAccounts();
    const trades = await getMyfxHistory(accountId);

    let imported = 0;
    trades.forEach(trade => {
      const exists = tradesData.some(t =>
        t.pair === trade.symbol &&
        new Date(t.date).getTime() === new Date(trade.openTime).getTime() &&
        parseFloat(t.pnl) === parseFloat(trade.profit)
      );

      if (!exists) {
        tradesData.push({
          id: Date.now() + Math.random(),
          pair: trade.symbol,
          direction: trade.action === "Buy" ? "Long" : "Short",
          date: new Date(trade.openTime),
          pnl: parseFloat(trade.profit),
          resultType: trade.profit >= 0 ? "win" : "loss"
        });
        imported++;
      }
    });

    saveTrades();
    loadTrades();
    alert(`üì• ${imported} neue Trades importiert!`);
  }

  // Automatisch E-Mail, Passwort & Session laden
  window.addEventListener("load", async () => {
    const savedEmail = localStorage.getItem("myfxEmail");
    const savedPw = localStorage.getItem("myfxPassword");
    const savedSession = localStorage.getItem("myfxSession");

    if (savedEmail && savedPw) {
      document.getElementById("myfxEmail").value = savedEmail;
      document.getElementById("myfxPassword").value = savedPw;
    }

    if (savedSession) {
      myfxSession = savedSession;
      console.log("‚úÖ Session wiederhergestellt.");
    }
  });
</script>


</script>
</body>
</html>
